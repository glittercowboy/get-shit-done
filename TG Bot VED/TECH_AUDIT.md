# Технический аудит проекта `TG Bot VED`

Дата первичного аудита: 2026-02-17  
Дата актуализации: 2026-02-17

## 1) Executive summary (актуально)

Проект находится в состоянии **MVP QA-ready**: базовые сценарии работают, добавлены автопроверки, а критичные риски из первичного аудита частично закрыты.

### Что уже закрыто после первичного аудита
- ✅ Добавлены автоматические проверки (`pytest`) и CI workflow (`py_compile` + `pytest`).
- ✅ Убрана неперсистентность режима пользователя: mode сохраняется в SQLite (`users.mode`).
- ✅ Усилен контракт LLM-ответа: добавлена схема JSON + дополнительная runtime-валидация.
- ✅ Добавлены safeguards для БД: индекс `idx_queries_chat_id_id` и ограничение длины полей `description/result`.

Итоговая оценка после актуализации: **7.8/10 (готов к тестовым прогонам; перед продом нужны доработки по наблюдаемости и качеству поиска)**.

---

## 2) Что проверялось

- Архитектура обработчиков Telegram и FSM-диалога (`bot_with_check_updated.py`).
- Работа с БД SQLite (инициализация, запись истории, индексация, хранение режима).
- Поток классификации и fallback-логика с/без OpenAI.
- Импорт справочника кодов из PDF (`import_codes.py`).
- Операционная готовность: зависимости, тесты, CI, документация запуска.

---

## 3) Актуальные риски (после доработок)

### MEDIUM-1: Качество fallback-поиска без OpenAI
**Риск:** поиск по `LIKE` может давать нерелевантные кандидаты на сложных формулировках.

**Рекомендация:**
- Рассмотреть FTS5 для `tnved.title`.
- Добавить скоринг по числу совпавших токенов и весам признаков.

---

### MEDIUM-2: Ограниченная наблюдаемость
**Риск:** затруднён разбор качества и деградаций в длительных прогонах.

**Рекомендация:**
- Добавить структурированные метрики (кол-во fallback, ошибки парсинга LLM, latency по командам).
- Вынести ключевые технические события в единый формат логов.

---

### MEDIUM-3: Нет интеграционных e2e тестов Telegram-flow
**Риск:** unit/smoke тесты не полностью покрывают FSM-ветки и UX-сценарии.

**Рекомендация:**
- Добавить интеграционные тесты на критичные цепочки (`/start` → mode → `/classify` / `/suggest` / `/check`).

---

### LOW-1: Документация roadmap-статусов
**Риск:** часть исторических документов может расходиться с фактическим состоянием.

**Рекомендация:**
- Пометить `ROADMAP.md` как архивный или обновить статус задач по факту реализации.

---

## 4) Сильные стороны реализации

- Безопасная конфигурация через `.env` и проверка `BOT_TOKEN` при старте.
- Персистентность режима пользователя (Light/Expert) в БД.
- Плавная деградация при недоступности OpenAI (fallback на БД).
- Юридический дисклеймер в пользовательских ответах с кодами.
- Наличие smoke-тестов и CI-пайплайна для базового контроля регрессий.

---

## 5) Приоритетный план улучшений

### Спринт 1
1. Улучшить релевантность fallback-поиска (FTS5/скоринг).
2. Добавить метрики и структурированные технические логи.

### Спринт 2
1. Добавить интеграционные e2e тесты по основным пользовательским сценариям.
2. Обновить/архивировать исторические документы статуса (`ROADMAP`).

---

## 6) Вердикт

Для **полноценного тестового прогона (QA/UAT)** проект готов при выполнении базовых предусловий (валидный `BOT_TOKEN`, загруженная `tnved` БД, и `OPENAI_API_KEY` для LLM-веток).

Для **production-эксплуатации** рекомендуется закрыть риски уровня MEDIUM (поиск, наблюдаемость, интеграционные тесты).
