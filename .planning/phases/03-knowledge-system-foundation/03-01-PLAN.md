---
phase: 03-knowledge-system-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/knowledge-db.js
  - package.json
autonomous: true

must_haves:
  truths:
    - "Database initializes with correct schema on first access"
    - "Global and project scope paths resolve correctly"
    - "Per-user database files use username from OS"
    - "Schema migrations apply via PRAGMA user_version"
    - "WAL mode enabled for concurrency"
  artifacts:
    - path: "get-shit-done/bin/knowledge-db.js"
      provides: "Database connection, schema, migrations"
      min_lines: 200
      exports: ["openKnowledgeDB", "closeKnowledgeDB", "migrateDatabase", "getDBPath"]
  key_links:
    - from: "get-shit-done/bin/knowledge-db.js"
      to: "better-sqlite3"
      via: "require/import"
      pattern: "require.*better-sqlite3"
    - from: "get-shit-done/bin/knowledge-db.js"
      to: "sqlite-vec"
      via: "extension load"
      pattern: "sqliteVec\\.load"
---

<objective>
Create SQLite + sqlite-vec database infrastructure for the knowledge system.

Purpose: Establish the foundational database layer that all knowledge operations depend on, including schema creation, migrations, and connection management.

Output: `knowledge-db.js` module with database initialization, schema, and migration support.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/03-knowledge-system-foundation/03-RESEARCH.md
@.planning/codebase/CONVENTIONS.md
@.planning/codebase/ARCHITECTURE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add database dependencies to package.json</name>
  <files>package.json</files>
  <action>
Add production dependencies to package.json:
- `better-sqlite3`: "^12.0.0" (synchronous SQLite driver with extension support)
- `sqlite-vec`: "^0.1.0" (vector search extension)

These are the only external dependencies the knowledge system needs. The better-sqlite3 package requires native compilation; this is acceptable for a Node.js CLI tool.

Update the engines field if needed to ensure Node.js 18+ compatibility (better-sqlite3 v12 requires Node 18+).
  </action>
  <verify>
Run `npm install` and verify both packages install without errors. Check that `node_modules/better-sqlite3` and `node_modules/sqlite-vec` exist.
  </verify>
  <done>
package.json has better-sqlite3 and sqlite-vec in dependencies. npm install succeeds.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create knowledge-db.js with schema and initialization</name>
  <files>get-shit-done/bin/knowledge-db.js</files>
  <action>
Create new file `get-shit-done/bin/knowledge-db.js` implementing:

**Database path resolution:**
```javascript
function getDBPath(scope) {
  const username = require('os').userInfo().username;
  if (scope === 'global') {
    return path.join(require('os').homedir(), '.claude', 'knowledge', `${username}.db`);
  } else {
    return path.join(process.cwd(), '.planning', 'knowledge', `${username}.db`);
  }
}
```

**Connection management:**
- `openKnowledgeDB(scope)` - Opens or creates database, loads sqlite-vec, enables WAL mode, runs migrations
- `closeKnowledgeDB(db)` - Properly closes database connection
- Cache open connections per path to avoid repeated opens

**Schema (version 1):**
```sql
CREATE TABLE knowledge (
  id INTEGER PRIMARY KEY,
  content TEXT NOT NULL,
  type TEXT NOT NULL,           -- 'decision', 'lesson', 'summary', 'temp_note'
  scope TEXT NOT NULL,           -- 'global' or 'project'
  created_at INTEGER NOT NULL,   -- Unix timestamp ms
  expires_at INTEGER,            -- TTL: NULL = permanent
  access_count INTEGER DEFAULT 0,
  last_accessed INTEGER,
  content_hash TEXT,             -- SHA-256 for deduplication
  metadata TEXT                  -- JSON blob
);

CREATE VIRTUAL TABLE knowledge_fts USING fts5(
  content,
  content='knowledge',
  content_rowid='id',
  tokenize='porter unicode61'
);

-- FTS5 sync triggers (INSERT, UPDATE, DELETE)

CREATE VIRTUAL TABLE knowledge_vec USING vec0(
  embedding float[512],
  distance_metric=cosine
);

CREATE INDEX idx_knowledge_expires ON knowledge(expires_at) WHERE expires_at IS NOT NULL;
CREATE INDEX idx_knowledge_type_access ON knowledge(type, access_count DESC);
CREATE INDEX idx_knowledge_hash ON knowledge(content_hash);
```

**Migration system:**
- Use PRAGMA user_version for schema versioning
- `migrateDatabase(db)` applies all migrations from current version
- Each migration is a function that executes SQL and increments version

**WAL and pragmas:**
```javascript
db.pragma('journal_mode = WAL');
db.pragma('synchronous = NORMAL');
db.pragma('cache_size = -10000'); // 40MB cache
db.pragma('temp_store = MEMORY');
```

Follow conventions from CONVENTIONS.md:
- camelCase function names
- snake_case for object keys in return values
- Use `safeReadFile` pattern for error handling
- Section dividers with unicode box-drawing

Export: `{ openKnowledgeDB, closeKnowledgeDB, migrateDatabase, getDBPath }`
  </action>
  <verify>
Create a test script that:
1. Opens a global knowledge DB
2. Opens a project knowledge DB
3. Verifies both have correct schema (check for knowledge, knowledge_fts, knowledge_vec tables)
4. Verifies PRAGMA user_version is set
5. Closes both connections

Run: `node -e "const k = require('./get-shit-done/bin/knowledge-db.js'); const db = k.openKnowledgeDB('project'); console.log(db.prepare('SELECT name FROM sqlite_master WHERE type=\\'table\\'').all()); k.closeKnowledgeDB(db);"`
  </verify>
  <done>
knowledge-db.js exists with schema creation, WAL mode, sqlite-vec loaded, and migrations working. Both global and project scope paths resolve correctly. Tables knowledge, knowledge_fts, knowledge_vec created on first open.
  </done>
</task>

<task type="auto">
  <name>Task 3: Add directory creation and graceful degradation</name>
  <files>get-shit-done/bin/knowledge-db.js</files>
  <action>
Enhance knowledge-db.js with:

**Directory creation:**
Before opening database, ensure parent directory exists:
```javascript
const dbDir = path.dirname(dbPath);
if (!fs.existsSync(dbDir)) {
  fs.mkdirSync(dbDir, { recursive: true });
}
```

**Graceful failure detection:**
Add `isKnowledgeDBAvailable(scope)` function that:
1. Checks if better-sqlite3 can be required (handles missing native bindings)
2. Returns `{ available: boolean, reason?: string }`
3. Does NOT throw - returns structured result

**Safe wrapper:**
Add `withKnowledgeDB(scope, fn)` helper that:
1. Checks availability
2. If not available, returns `{ skipped: true, reason: '...' }`
3. If available, opens DB, runs fn(db), closes DB, returns result
4. Handles errors gracefully

This supports KNOW-04 (fallback when DB missing).

**Extension loading error handling:**
sqlite-vec may fail to load on some platforms. Wrap extension loading:
```javascript
try {
  sqliteVec.load(db);
} catch (err) {
  // Vector search not available, but FTS5 still works
  console.warn('sqlite-vec extension unavailable:', err.message);
  return { db, vectorEnabled: false };
}
```

Return connection object with capabilities:
```javascript
{ db, vectorEnabled: boolean, ftsEnabled: boolean, scope: string }
```
  </action>
  <verify>
1. Remove node_modules/better-sqlite3 temporarily
2. Call `isKnowledgeDBAvailable('project')` - should return `{ available: false, reason: '...' }`
3. Restore node_modules
4. Call `isKnowledgeDBAvailable('project')` - should return `{ available: true }`
5. Verify directories are created if missing
  </verify>
  <done>
Directory creation works. `isKnowledgeDBAvailable` returns correct status. `withKnowledgeDB` provides safe wrapper. Missing dependencies or extensions degrade gracefully without throwing.
  </done>
</task>

</tasks>

<verification>
1. `npm install` succeeds with new dependencies
2. `require('./get-shit-done/bin/knowledge-db.js')` succeeds
3. Opening project and global databases creates files at correct paths
4. Schema includes knowledge, knowledge_fts, knowledge_vec tables
5. PRAGMA user_version tracks schema version
6. Graceful degradation when dependencies missing
</verification>

<success_criteria>
- better-sqlite3 and sqlite-vec installed as dependencies
- knowledge-db.js exports: openKnowledgeDB, closeKnowledgeDB, migrateDatabase, getDBPath, isKnowledgeDBAvailable, withKnowledgeDB
- Database files created at ~/.claude/knowledge/{user}.db and .planning/knowledge/{user}.db
- WAL mode enabled, sqlite-vec extension loaded
- Migration system tracks schema version via PRAGMA user_version
- Missing dependencies detected gracefully
</success_criteria>

<output>
After completion, create `.planning/phases/03-knowledge-system-foundation/03-01-SUMMARY.md`
</output>
