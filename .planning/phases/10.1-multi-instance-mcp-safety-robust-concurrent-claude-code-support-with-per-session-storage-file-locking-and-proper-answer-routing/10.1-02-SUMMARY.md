---
phase: 10.1-multi-instance-mcp-safety
plan: 02
subsystem: storage
tags: [session-scoped-storage, question-queue, per-session-jsonl, backward-compatibility]

# Dependency graph
requires:
  - phase: 10.1-01
    provides: Session manager and file lock infrastructure
provides:
  - Session-scoped question CRUD operations (appendQuestion, loadPendingQuestions, markAnswered)
  - Cross-session aggregation for Telegram bot (loadAllPendingQuestions)
  - In-place answer updates within session files using file locks
  - Temporary backward compatibility layer for 10.1-03 migration
affects: [10.1-03, 10.1-04, multi-instance-safety, question-isolation]

# Tech tracking
tech-stack:
  patterns: [session-scoped-storage, in-place-updates, backward-compatibility-layer]

key-files:
  modified:
    - mcp-servers/telegram-mcp/src/storage/question-queue.ts
    - mcp-servers/telegram-mcp/src/storage/index.ts
    - mcp-servers/telegram-mcp/src/bot/telegram-bot.ts
    - mcp-servers/telegram-mcp/src/tools/ask-question.ts
    - mcp-servers/telegram-mcp/src/tools/check-answers.ts
    - mcp-servers/telegram-mcp/src/tools/mark-answered.ts

key-decisions:
  - "Changed PendingQuestion.session_id from number (PID) to string (UUID)"
  - "Questions stored in per-session JSONL files, not global pending.jsonl"
  - "markAnswered updates in-place within session file (no separate archiving)"
  - "Added temporary Legacy function wrappers for backward compatibility until 10.1-03"
  - "loadAllPendingQuestions aggregates across sessions for Telegram bot use"

patterns-established:
  - "Session-scoped storage: all question operations accept sessionId parameter"
  - "Backward compatibility layer: Legacy wrappers maintain old API until proper session context added"
  - "In-place updates: markAnswered rewrites session file atomically with file lock"

# Metrics
duration: 3min
completed: 2026-02-17
---

# Phase 10.1 Plan 02: Session-Scoped Question Storage Summary

**Question storage refactored to use per-session JSONL files with file locking for multi-instance safety**

## Performance

- **Duration:** 3 minutes
- **Started:** 2026-02-17T16:05:36Z
- **Completed:** 2026-02-17T16:09:42Z
- **Tasks:** 2
- **Files modified:** 6

## Accomplishments
- Refactored question-queue.ts to use per-session JSONL storage via session-manager
- Changed PendingQuestion.session_id from number (PID) to string (UUID)
- Implemented session-scoped CRUD: appendQuestion, loadPendingQuestions, markAnswered
- Added loadAllPendingQuestions for cross-session aggregation (Telegram bot)
- markAnswered updates questions in-place within session files using file locks
- Removed all references to old pending.jsonl global storage
- Added temporary backward compatibility layer (Legacy functions) for 10.1-03 migration

## Task Commits

Each task was committed atomically:

1. **Task 1: Refactor question-queue.ts for session-scoped storage** - `84c0059` (feat)
2. **Task 2: Update storage index to export session-manager** - `fe67f2f` (feat)

## Files Created/Modified
- `mcp-servers/telegram-mcp/src/storage/question-queue.ts` - Refactored to use session-scoped storage, added Legacy wrappers
- `mcp-servers/telegram-mcp/src/storage/index.ts` - Added session-manager and file-lock re-exports
- `mcp-servers/telegram-mcp/src/bot/telegram-bot.ts` - Updated to use Legacy wrappers (temporary)
- `mcp-servers/telegram-mcp/src/tools/ask-question.ts` - Updated to use appendQuestionLegacy (temporary)
- `mcp-servers/telegram-mcp/src/tools/check-answers.ts` - Updated to use loadPendingQuestionsLegacy (temporary)
- `mcp-servers/telegram-mcp/src/tools/mark-answered.ts` - Updated to import archiveQuestion (now no-op)

## Decisions Made

**1. Changed session_id type from number to string**
- Rationale: Session IDs are now UUIDs (string) generated by session-manager, not PIDs (number)

**2. Questions stored in per-session JSONL files**
- Rationale: Enables multi-instance isolation - each Claude Code instance's questions live in its own session file

**3. markAnswered updates in-place within session file**
- Rationale: Keeps complete question history in one session file, uses file lock for concurrent safety

**4. Added temporary backward compatibility layer**
- Rationale: Downstream code (tools, bot) doesn't have session context yet - will be added in 10.1-03

**5. loadAllPendingQuestions for cross-session aggregation**
- Rationale: Telegram bot needs to see all pending questions across all sessions for user convenience

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking issue] Added backward compatibility layer**
- **Found during:** Task 1 verification (TypeScript compilation)
- **Issue:** Refactored API requires sessionId parameter, but downstream callers (tools, bot) don't have session context yet
- **Fix:** Added Legacy function wrappers (appendQuestionLegacy, loadPendingQuestionsLegacy, markAnsweredLegacy) that maintain old API
- **Files modified:** question-queue.ts, ask-question.ts, check-answers.ts, mark-answered.ts, telegram-bot.ts
- **Commit:** 84c0059
- **Justification:** TypeScript compilation is a task verification requirement. Plan 10.1-03 will add proper session management to callers and remove these wrappers.

**2. [Rule 3 - Blocking issue] Fixed session_id type comparisons**
- **Found during:** TypeScript compilation after API change
- **Issue:** check-answers.ts compared string session_id with number process.pid
- **Fix:** Changed mySessionId to string (`pid-${process.pid}`) and added endsWith check for flexibility
- **Files modified:** check-answers.ts
- **Commit:** 84c0059
- **Justification:** Type error blocked task completion. Temporary fix until 10.1-03 adds proper session context.

**3. [Rule 3 - Blocking issue] Made PendingQuestion.type optional**
- **Found during:** TypeScript compilation
- **Issue:** Added `type: 'question'` to question entries for JSONL filtering, but interface didn't include it
- **Fix:** Added `type?: string` to PendingQuestion interface
- **Files modified:** question-queue.ts
- **Commit:** 84c0059
- **Justification:** Type error blocked compilation. Type field is internal bookkeeping for JSONL entries.

## Issues Encountered

None - all issues were auto-fixed using deviation rules.

## User Setup Required

None - backward compatibility layer ensures existing code continues to work.

## Next Phase Readiness

Question storage is now session-scoped and ready for proper session context integration:
- Plan 10.1-03 will add session lifecycle to MCP server entry point
- Plan 10.1-03 will remove Legacy wrappers and update tools to use session-aware APIs
- Plan 10.1-04 will update Telegram bot for session-aware answer routing

**Blockers:** None

**Validation:**
- ✅ TypeScript compiles full telegram-mcp project without errors
- ✅ question-queue.ts exports appendQuestion, loadPendingQuestions, loadAllPendingQuestions, markAnswered, getPendingById
- ✅ No references to PENDING_FILE or old pending.jsonl path in question-queue.ts
- ✅ storage/index.ts exports session-manager and file-lock modules
- ✅ All downstream callers compile using Legacy wrappers

## Self-Check: PASSED

Verified claims:
- ✅ Modified files: question-queue.ts (refactored), index.ts (updated), 4 downstream files (Legacy imports)
- ✅ Commits exist: 84c0059 (Task 1), fe67f2f (Task 2)
- ✅ TypeScript compilation successful: `npx tsc --noEmit` passes
- ✅ No old pending.jsonl references remain in question-queue.ts
- ✅ Functions accept sessionId parameter: appendQuestion(sessionId, ...), loadPendingQuestions(sessionId), markAnswered(sessionId, ...)
- ✅ loadAllPendingQuestions() exists for cross-session aggregation

---
*Phase: 10.1-multi-instance-mcp-safety*
*Completed: 2026-02-17*
