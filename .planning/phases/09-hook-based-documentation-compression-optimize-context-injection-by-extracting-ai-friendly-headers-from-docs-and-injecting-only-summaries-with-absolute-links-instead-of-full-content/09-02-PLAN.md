---
phase: 09-hook-based-documentation-compression
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/get-shit-done/bin/gsd-tools.js
  - ~/.claude/skills/task-context/SKILL.md
autonomous: true

must_haves:
  truths:
    - "gsd-tools routing commands include summaries in context matches"
    - "SKILL.md provides task context routing via skill invocation"
    - "Top 3 docs returned with title, summary, absolute file link"
    - "Model recommendation included in skill output"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/gsd-tools.js"
      provides: "Extended routing commands with summary extraction"
      contains: "compress summary"
    - path: "~/.claude/skills/task-context/SKILL.md"
      provides: "Task Context Skill definition"
      contains: "name: task-context"
  key_links:
    - from: "gsd-tools.js"
      to: "header-extractor.js"
      via: "require('./compression/header-extractor')"
      pattern: "HeaderExtractor"
    - from: "SKILL.md"
      to: "gsd-tools.js"
      via: "gsd-tools.js routing full"
      pattern: "routing full"
---

<objective>
Extend Phase 1 routing infrastructure with summary extraction and create the Task Context Skill (SKILL.md format).

Purpose: Enable orchestrators to get intelligent task routing + relevant doc context before spawning subagents.
Output: Extended gsd-tools.js commands and task-context SKILL.md.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-RESEARCH.md

Reference existing Phase 1 implementation:
@~/.claude/get-shit-done/bin/gsd-tools.js (lines 2469-2635)

Reference Phase 1 user decisions:
- Top 3 docs per task
- Keyword extraction + explicit frontmatter tags
- Hybrid: index once per session, refresh on file changes
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add compress summary CLI command to gsd-tools</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
  Add new `compress` command group to gsd-tools.js:

  1. **compress summary <filepath> [--raw]**
     - Reads file at filepath
     - Uses HeaderExtractor to generate summary
     - With `--raw`: outputs summary markdown directly (for piping)
     - Without `--raw`: outputs JSON with summary, sections, reductionPercent

  2. **compress stats**
     - Reports compression statistics from session (if tracking enabled)
     - Shows average reduction, files compressed, tokens saved

  Add to command routing section (after existing routing commands):

  ```javascript
  if (command === 'compress' && subCommand === 'summary') {
    const filePath = args[2];
    const raw = args.includes('--raw');
    cmdCompressSummary(filePath, raw);
  } else if (command === 'compress' && subCommand === 'stats') {
    cmdCompressStats(raw);
  }
  ```

  Implementation function:
  ```javascript
  function cmdCompressSummary(filePath, raw) {
    if (!filePath) { error('file path required'); return; }
    const absolutePath = path.resolve(filePath);
    if (!fs.existsSync(absolutePath)) { error('file not found: ' + absolutePath); return; }

    const { HeaderExtractor } = require('./compression/header-extractor');
    const extractor = new HeaderExtractor();
    const content = fs.readFileSync(absolutePath, 'utf-8');
    const result = extractor.extractSummary(content, absolutePath);

    if (raw) {
      console.log(result.summary);
    } else {
      const reductionPercent = ((1 - result.summary.length / content.length) * 100).toFixed(1);
      output({ ...result, originalLength: content.length, reductionPercent }, false);
    }
  }
  ```
  </action>
  <verify>
  ```bash
  node ~/.claude/get-shit-done/bin/gsd-tools.js compress summary ~/.claude/get-shit-done/README.md
  ```
  </verify>
  <done>compress summary command outputs JSON with summary, sections, originalLength, reductionPercent</done>
</task>

<task type="auto">
  <name>Task 2: Extend routing full command to include summaries</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
  Extend the existing `cmdRoutingFull` function (around line 2606) to include summaries:

  1. After matching context docs, extract summaries for each match:
  ```javascript
  function cmdRoutingFull(cwd, taskDesc, raw) {
    // ... existing model selection logic ...

    const index = loadContextIndex(cwd);
    const contextMatches = matchContextDocs(taskDesc, index, 3);

    // NEW: Extract summaries for matched docs
    const { HeaderExtractor } = require('./compression/header-extractor');
    const extractor = new HeaderExtractor();

    const contextWithSummaries = contextMatches.map(match => {
      try {
        const content = fs.readFileSync(match.path, 'utf-8');
        const { summary } = extractor.extractSummary(content, match.path);
        return { ...match, summary };
      } catch (err) {
        return { ...match, summary: null, error: err.message };
      }
    });

    output({
      task: taskDesc,
      model: modelResult,
      context: contextWithSummaries,  // Now includes summaries
      claude_md: {
        has_instructions: claudeInstructions.instructions.length > 0,
        relevant_keywords: claudeInstructions.keywords.filter(k =>
          extractKeywords(taskDesc).includes(k)
        ).slice(0, 10)
      }
    }, raw);
  }
  ```

  2. Also update `buildContextIndex` to optionally pre-compute summaries:
  - Add `includeSummaries` option (default false for speed)
  - When true, store summary in index entry
  - Allows cached summaries vs on-demand extraction

  3. Add `routing index-build --with-summaries` flag to build index with pre-computed summaries.
  </action>
  <verify>
  ```bash
  node ~/.claude/get-shit-done/bin/gsd-tools.js routing full "Create Supabase RLS policy" | jq '.context[0].summary' | head -20
  ```
  </verify>
  <done>routing full output includes summary field for each matched doc (null if extraction failed)</done>
</task>

<task type="auto">
  <name>Task 3: Create Task Context Skill (SKILL.md)</name>
  <files>~/.claude/skills/task-context/SKILL.md</files>
  <action>
  Create the task-context skill directory and SKILL.md file:

  1. Create directory: `mkdir -p ~/.claude/skills/task-context`

  2. Write SKILL.md following Agent Skills standard:

  ```markdown
  ---
  name: task-context
  description: Determines optimal model tier and injects relevant documentation context for a task. Returns model recommendation (haiku/sonnet/opus) plus top 3 matching docs with summaries and file links.
  ---

  # Task Context Skill

  You provide intelligent task routing and context injection. Given a task description, you analyze it and return structured recommendations.

  ## Input

  You receive a task description as a single-line prompt. Extract keywords and match against documentation.

  ## Process

  1. **Execute routing command:**
     ```bash
     node ~/.claude/get-shit-done/bin/gsd-tools.js routing full "<task description>"
     ```

  2. **Parse JSON output** containing:
     - `model`: Recommended model tier with reason
     - `context`: Array of matched docs with paths, titles, scores, summaries
     - `claude_md`: Relevant CLAUDE.md keywords

  3. **Format structured response:**

     ## TASK CONTEXT

     **Model:** <model tier from routing>
     **Reason:** <reason from routing rules>

     **Documentation Context:**

     ### 1. <Doc Title>
     <Summary text - first paragraph or 2-3 bullet points>

     **Full content:** file://<absolute-path>

     ### 2. <Doc Title>
     <Summary text>

     **Full content:** file://<absolute-path>

     ### 3. <Doc Title>
     <Summary text>

     **Full content:** file://<absolute-path>

     **CLAUDE.md Keywords:** <comma-separated list or "none">

  ## Output

  Sub-coordinator receives this structured response and:
  1. Uses model tier for Task spawn
  2. Includes documentation summaries in task prompt
  3. Provides file:// links for full content access when needed
  4. Injects CLAUDE.md keywords as context reminders

  ## Important

  - Always return a decision (default to sonnet if no patterns match)
  - Summaries should be 1-3 sentences or 2-4 bullet points MAX
  - Full doc paths must be absolute (file:///full/path.md)
  - This is a fast operation - complete in <10 seconds
  - If routing command fails, report error and default to sonnet with no docs
  ```
  </action>
  <verify>
  ```bash
  cat ~/.claude/skills/task-context/SKILL.md | head -30
  ls -la ~/.claude/skills/task-context/
  ```
  </verify>
  <done>SKILL.md exists with proper YAML frontmatter (name, description) and markdown instructions</done>
</task>

</tasks>

<verification>
Run the following to verify the complete implementation:

```bash
# 1. Test compress summary command
node ~/.claude/get-shit-done/bin/gsd-tools.js compress summary ~/get-shit-done/.planning/ROADMAP.md

# 2. Test routing full with summaries
node ~/.claude/get-shit-done/bin/gsd-tools.js routing full "Create database migration" | jq '{model: .model.tier, docs: [.context[] | {title, score, has_summary: (.summary != null)}]}'

# 3. Verify SKILL.md structure
cat ~/.claude/skills/task-context/SKILL.md | head -5
grep -c "name: task-context" ~/.claude/skills/task-context/SKILL.md
```

Expected:
- compress summary returns JSON with reductionPercent >= 60%
- routing full includes summary for each matched doc
- SKILL.md has correct frontmatter with name: task-context
</verification>

<success_criteria>
1. `gsd-tools compress summary <path>` outputs summary with reduction percentage
2. `gsd-tools routing full <task>` includes summaries in context array
3. SKILL.md exists at ~/.claude/skills/task-context/SKILL.md
4. SKILL.md has valid YAML frontmatter with name and description
5. SKILL.md provides clear instructions for executing routing command
6. All docs in routing full output have summary field (null if extraction failed)
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-02-SUMMARY.md`
</output>
