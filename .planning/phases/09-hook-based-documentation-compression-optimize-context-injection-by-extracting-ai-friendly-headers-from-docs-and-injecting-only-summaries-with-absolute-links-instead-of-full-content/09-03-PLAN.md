---
phase: 09-hook-based-documentation-compression
plan: 03
type: execute
wave: 2
depends_on: ["09-01"]
files_modified:
  - ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js
  - ~/.claude/get-shit-done/bin/hooks/config.js
  - ~/.claude/settings.json
autonomous: true

must_haves:
  truths:
    - "PreToolUse hook intercepts Read operations on GSD documentation files"
    - "Hook returns compressed summary via additionalContext"
    - "Files smaller than threshold are passed through uncompressed"
    - "Hook configuration stored in hooks/config.js"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js"
      provides: "PreToolUse hook for documentation compression"
      min_lines: 60
    - path: "~/.claude/get-shit-done/bin/hooks/config.js"
      provides: "Hook configuration with compression settings"
      exports: ["loadHookConfig", "saveHookConfig", "DEFAULT_HOOK_CONFIG"]
    - path: "~/.claude/settings.json"
      provides: "Hook registration for PreToolUse"
      contains: "doc-compression-hook.js"
  key_links:
    - from: "doc-compression-hook.js"
      to: "header-extractor.js"
      via: "require('../compression/header-extractor')"
      pattern: "HeaderExtractor"
    - from: "doc-compression-hook.js"
      to: "config.js"
      via: "require('./config')"
      pattern: "loadHookConfig"
    - from: "settings.json"
      to: "doc-compression-hook.js"
      via: "hooks.PreToolUse"
      pattern: "doc-compression-hook"
---

<objective>
Create PreToolUse hook for automatic GSD documentation compression and integrate with Claude Code hooks system.

Purpose: Automatically compress large GSD docs (RESEARCH.md, PLAN.md, STATE.md) to reduce context consumption by 60-70%.
Output: Working PreToolUse hook registered in settings.json with configurable compression settings.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-RESEARCH.md

Reference 09-01-SUMMARY.md for header-extractor.js implementation:
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-01-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hook configuration module</name>
  <files>~/.claude/get-shit-done/bin/hooks/config.js</files>
  <action>
  Create the hooks/config.js module with compression configuration:

  1. **DEFAULT_HOOK_CONFIG** object:
  ```javascript
  const DEFAULT_HOOK_CONFIG = {
    enabled: true,
    compression: {
      enabled: true,
      strategy: 'header-extraction',
      min_file_lines: 500,           // Skip files smaller than 500 lines
      target_reduction: 65,           // Aim for 65% reduction
      cache_ttl: 300,                 // 5 minutes cache TTL
      patterns: [
        '**/*-RESEARCH.md',
        '**/*-PLAN.md',
        '**/*-CONTEXT.md',
        '**/STATE.md',
        '**/ROADMAP.md',
        '**/PROJECT.md'
      ],
      exclude: [
        '**/*-SUMMARY.md',           // Already compressed
        '**/README.md'               // Usually short
      ],
      fallback: 'pass-through'       // On error: pass-through (don't block)
    }
  };
  ```

  2. **loadHookConfig()** function:
     - Reads config from ~/.claude/get-shit-done/hook-config.json
     - Returns merged config (defaults + user overrides)
     - Creates config file with defaults if missing

  3. **saveHookConfig(config)** function:
     - Writes config to hook-config.json
     - Used for runtime config updates (enable/disable compression)

  4. **matchesPattern(filePath, patterns, excludes)** function:
     - Uses minimatch for glob pattern matching
     - Returns true if filePath matches any pattern and no excludes

  Export all functions and DEFAULT_HOOK_CONFIG.
  </action>
  <verify>
  ```bash
  mkdir -p ~/.claude/get-shit-done/bin/hooks
  node -e "
    const { DEFAULT_HOOK_CONFIG, loadHookConfig } = require('$HOME/.claude/get-shit-done/bin/hooks/config');
    console.log('Default config:', JSON.stringify(DEFAULT_HOOK_CONFIG.compression, null, 2));
    const config = loadHookConfig();
    console.log('Loaded config enabled:', config.compression.enabled);
  "
  ```
  </verify>
  <done>loadHookConfig returns merged configuration with compression settings. Config file created at hook-config.json if missing.</done>
</task>

<task type="auto">
  <name>Task 2: Create PreToolUse compression hook</name>
  <files>~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js</files>
  <action>
  Create doc-compression-hook.js that intercepts Read operations:

  1. **Shebang and imports:**
  ```javascript
  #!/usr/bin/env node

  const fs = require('fs');
  const path = require('path');
  const { HeaderExtractor } = require('../compression/header-extractor');
  const { loadHookConfig, matchesPattern } = require('./config');
  ```

  2. **DOC_PATTERNS regex array** for quick pattern check:
  ```javascript
  const DOC_PATTERNS = [
    /.*-RESEARCH\.md$/,
    /.*-PLAN\.md$/,
    /.*-CONTEXT\.md$/,
    /STATE\.md$/,
    /ROADMAP\.md$/,
    /PROJECT\.md$/
  ];
  ```

  3. **main() async function:**
     - Reads stdin (JSON: { tool, parameters })
     - Exit 0 if tool !== 'Read' (pass through)
     - Exit 0 if file_path missing
     - Check if file matches DOC_PATTERNS
     - Load config, check if compression enabled
     - Check file size (lines) vs min_file_lines threshold
     - Read file, compress using HeaderExtractor
     - Output JSON: { additionalContext: summary, metadata: {...} }
     - Wrap ALL logic in try/catch, exit 0 on error (pass through)

  4. **Error handling:**
     - Log errors to stderr (not stdout, which is hook output)
     - Always exit 0 to not block reads
     - Include error message in metadata if compression fails

  Pattern from research:
  ```javascript
  async function main() {
    try {
      const chunks = [];
      for await (const chunk of process.stdin) {
        chunks.push(chunk);
      }
      const input = Buffer.concat(chunks).toString();
      const toolUse = JSON.parse(input);

      if (toolUse.tool !== 'Read') {
        process.exit(0);
      }

      const filePath = toolUse.parameters?.file_path;
      // ... compression logic ...

      console.log(JSON.stringify(result));
      process.exit(0);
    } catch (error) {
      console.error('Doc compression hook error:', error.message);
      process.exit(0);
    }
  }

  main();
  ```

  Make file executable: `chmod +x doc-compression-hook.js`
  </action>
  <verify>
  ```bash
  chmod +x ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js
  echo '{"tool": "Read", "parameters": {"file_path": "'$HOME'/get-shit-done/.planning/ROADMAP.md"}}' | node ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js
  ```
  </verify>
  <done>Hook outputs JSON with additionalContext containing compressed summary. Non-matching files produce no output (exit 0).</done>
</task>

<task type="auto">
  <name>Task 3: Register hook in Claude Code settings</name>
  <files>~/.claude/settings.json</files>
  <action>
  Update ~/.claude/settings.json to register the PreToolUse hook:

  1. Read existing settings.json (or create if missing)

  2. Add hooks configuration:
  ```json
  {
    "hooks": {
      "PreToolUse": [
        {
          "matcher": "Read",
          "hooks": [
            {
              "type": "command",
              "command": "node ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js"
            }
          ]
        }
      ]
    }
  }
  ```

  3. Preserve existing settings (merge, don't replace)

  4. If hooks.PreToolUse already exists, append to the array rather than replace

  Note: Claude Code hook format may vary. Check Claude Code docs for exact format.
  Common formats:
  - Array of hook objects with matcher + hooks
  - Object with tool names as keys

  Start with the array format from research, adjust if needed based on actual Claude Code requirements.
  </action>
  <verify>
  ```bash
  cat ~/.claude/settings.json | jq '.hooks.PreToolUse'
  ```
  </verify>
  <done>settings.json contains PreToolUse hook registration pointing to doc-compression-hook.js</done>
</task>

</tasks>

<verification>
Run the following to verify the complete implementation:

```bash
# 1. Test config loading
node -e "
  const { loadHookConfig } = require('$HOME/.claude/get-shit-done/bin/hooks/config');
  const cfg = loadHookConfig();
  console.log('Compression enabled:', cfg.compression.enabled);
  console.log('Min lines:', cfg.compression.min_file_lines);
"

# 2. Test hook execution on matching file
echo '{"tool": "Read", "parameters": {"file_path": "'$HOME'/get-shit-done/.planning/ROADMAP.md"}}' | node ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js | jq '.metadata'

# 3. Test hook pass-through on non-matching file
echo '{"tool": "Read", "parameters": {"file_path": "'$HOME'/get-shit-done/README.md"}}' | node ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js
# Should produce no output (pass through)

# 4. Test hook pass-through on non-Read tool
echo '{"tool": "Write", "parameters": {"file_path": "/test.md"}}' | node ~/.claude/get-shit-done/bin/hooks/doc-compression-hook.js
# Should produce no output (pass through)

# 5. Verify settings.json hook registration
cat ~/.claude/settings.json | jq '.hooks'
```

Expected:
- Config loads with compression settings
- Matching files get compressed summary in additionalContext
- Non-matching files pass through (no output)
- Non-Read tools pass through
- settings.json has PreToolUse hook registered
</verification>

<success_criteria>
1. hooks/config.js exports loadHookConfig, saveHookConfig, DEFAULT_HOOK_CONFIG
2. doc-compression-hook.js intercepts Read operations
3. Hook compresses files matching DOC_PATTERNS
4. Hook passes through files under min_file_lines threshold
5. Hook outputs JSON with additionalContext on compression
6. Hook handles errors gracefully (exit 0, don't block reads)
7. settings.json registers PreToolUse hook
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-03-SUMMARY.md`
</output>
