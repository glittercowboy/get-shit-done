---
phase: 09-hook-based-documentation-compression
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - ~/.claude/get-shit-done/bin/token-monitor.js
  - ~/.claude/get-shit-done/bin/gsd-tools.js
autonomous: true
gap_closure: true

must_haves:
  truths:
    - "TokenBudgetMonitor triggers compression recommendations at 80% utilization"
  artifacts:
    - path: "~/.claude/get-shit-done/bin/token-monitor.js"
      provides: "TokenBudgetMonitor class with reserve/record/report methods"
      exports: ["TokenBudgetMonitor"]
    - path: "~/.claude/get-shit-done/bin/gsd-tools.js"
      provides: "Token CLI commands"
      exports: ["token init", "token reserve", "token record", "token report", "token reset"]
  key_links:
    - from: "token-monitor.js"
      to: ".planning/token_budget.json"
      via: "JSON file persistence"
      pattern: "fs\\.readFileSync.*token_budget"
    - from: "gsd-tools.js"
      to: "token-monitor.js"
      via: "require('./token-monitor')"
      pattern: "require.*token-monitor"
    - from: "token-monitor.js reserve()"
      to: "compress status recommendation"
      via: "80% threshold check"
      pattern: "recommendation.*compress|80.*compress"
---

<objective>
Close the gap identified in 09-VERIFICATION.md: Success Criterion 7 requires TokenBudgetMonitor to trigger compression recommendations at 80% utilization.

Purpose: Connect token budget monitoring with compression system to proactively recommend enabling compression when context usage is high.

Output: Working token monitoring with CLI commands and compression recommendation integration.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-VERIFICATION.md
@.planning/phases/07-autonomous-execution-optimization/07-RESEARCH.md (Pattern 1: Token Budget Monitoring)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create TokenBudgetMonitor module</name>
  <files>~/.claude/get-shit-done/bin/token-monitor.js</files>
  <action>
Create token-monitor.js implementing TokenBudgetMonitor class based on Pattern 1 from 07-RESEARCH.md:

```javascript
const fs = require('fs');
const path = require('path');

const TOKEN_LIMITS = {
  haiku: 200000,
  sonnet: 200000,
  opus: 200000
};

const ALERT_THRESHOLDS = {
  warn: 0.80,      // 80% - trigger compression recommendation
  critical: 0.90,  // 90% - escalate warnings
  stop: 0.95       // 95% - halt execution
};

class TokenBudgetMonitor {
  constructor(model = 'opus', maxTokens = 200000) { ... }

  // Reserve tokens before operation, returns { canProceed, utilization, recommendation }
  reserve(estimatedTokens, operation) {
    // At 80% utilization: add recommendation to enable compression
    // Return { canProceed: boolean, utilization: number, recommendation: string|null }
  }

  // Record actual token usage after operation
  recordUsage(actualTokens, phase) { ... }

  // Get usage report
  getReport() { ... }

  // Persist to JSON
  toJSON() { ... }
  static fromJSON(data) { ... }

  // Load/save from .planning/token_budget.json
  save(projectPath) { ... }
  static load(projectPath, model = 'opus') { ... }
}
```

Key requirements:
1. At 80% utilization in reserve(), include recommendation: "Consider enabling compression: `gsd-tools compress enable`"
2. Use existing .planning/token_budget.json location for persistence
3. Track per-phase usage in phaseUsage Map
4. Support graduated alerts (50%, 65%, 80%, 90%, 95%)
5. Export TokenBudgetMonitor class

The 80% threshold MUST trigger the compression recommendation - this is the gap being closed.
  </action>
  <verify>
```bash
# Verify module loads
node -e "const { TokenBudgetMonitor } = require('/Users/ollorin/.claude/get-shit-done/bin/token-monitor.js'); console.log('TokenBudgetMonitor loaded:', typeof TokenBudgetMonitor)"

# Verify 80% threshold recommendation
node -e "
const { TokenBudgetMonitor } = require('/Users/ollorin/.claude/get-shit-done/bin/token-monitor.js');
const monitor = new TokenBudgetMonitor('opus', 200000);
monitor.currentUsage = 150000; // 75%
const result = monitor.reserve(12000, 'test'); // Would push to 81%
console.log('At 81% utilization, recommendation:', result.recommendation);
if (!result.recommendation || !result.recommendation.includes('compress')) {
  console.error('ERROR: Missing compression recommendation at 80%+');
  process.exit(1);
}
console.log('SUCCESS: 80% threshold triggers compression recommendation');
"
```
  </verify>
  <done>TokenBudgetMonitor class exists with reserve() method that recommends compression at 80% utilization</done>
</task>

<task type="auto">
  <name>Task 2: Add token CLI commands to gsd-tools.js</name>
  <files>~/.claude/get-shit-done/bin/gsd-tools.js</files>
  <action>
Add 'token' case to the main switch statement in gsd-tools.js with these subcommands:

1. `token init <model>` - Initialize token budget for model (opus|sonnet|haiku)
   - Creates new TokenBudgetMonitor with model's limit
   - Saves to .planning/token_budget.json
   - Output: { initialized: true, model, maxTokens }

2. `token reserve <tokens> <operation>` - Check if operation can proceed
   - Loads existing budget, calls reserve()
   - Exit code 0 if can proceed, 1 if blocked
   - Output: { canProceed, utilization, recommendation, operation }
   - CRITICAL: At 80%+, output MUST include recommendation field

3. `token record <tokens> <phase>` - Record actual usage
   - Loads budget, calls recordUsage(), saves
   - Output: { recorded, phase, newUtilization }

4. `token report` - Display current budget status
   - Loads budget, calls getReport()
   - Output: { current_usage, max_tokens, utilization_percent, remaining_tokens, phase_breakdown, active_alerts }

5. `token reset` - Reset budget for new session
   - Creates fresh TokenBudgetMonitor, saves
   - Output: { reset: true, model }

Add require at top of file:
```javascript
const { TokenBudgetMonitor } = require('./token-monitor');
```

Add case in switch statement (near other CLI commands like 'compress'):
```javascript
case 'token': {
  const subcommand = args[1];
  // ... implementation
  break;
}
```

Update error message for unknown commands to include 'token' in available commands list.
  </action>
  <verify>
```bash
# Test each command
cd /Users/ollorin/get-shit-done

# Test init
node ~/.claude/get-shit-done/bin/gsd-tools.js token init opus
# Should output JSON with initialized: true

# Test reserve at low utilization
node ~/.claude/get-shit-done/bin/gsd-tools.js token reserve 10000 test-op
# Should output with canProceed: true

# Test reserve at high utilization (manually set high usage first)
node -e "
const fs = require('fs');
const budget = JSON.parse(fs.readFileSync('.planning/token_budget.json', 'utf-8'));
budget.currentUsage = 165000; // 82.5%
fs.writeFileSync('.planning/token_budget.json', JSON.stringify(budget, null, 2));
"
node ~/.claude/get-shit-done/bin/gsd-tools.js token reserve 1000 test-op
# Should output with recommendation containing 'compress'

# Test report
node ~/.claude/get-shit-done/bin/gsd-tools.js token report

# Test reset
node ~/.claude/get-shit-done/bin/gsd-tools.js token reset
```
  </verify>
  <done>Token CLI commands (init, reserve, record, report, reset) work via gsd-tools.js with compression recommendation at 80%</done>
</task>

<task type="auto">
  <name>Task 3: Integration test - end-to-end 80% threshold verification</name>
  <files>~/.claude/get-shit-done/bin/token-monitor.js</files>
  <action>
Create integration test that verifies the full gap closure:

1. Initialize fresh token budget
2. Record usage up to 79%
3. Verify reserve() does NOT recommend compression
4. Record usage to 80%
5. Verify reserve() DOES recommend compression with exact message
6. Verify the recommendation references gsd-tools compress command

Test script location: Add test function to token-monitor.js as exported selfTest() method:

```javascript
static selfTest() {
  const monitor = new TokenBudgetMonitor('opus', 200000);

  // Test 1: Below threshold - no recommendation
  monitor.currentUsage = 150000; // 75%
  const below = monitor.reserve(1000, 'test1');
  if (below.recommendation) {
    return { passed: false, error: 'Should not recommend at 75%' };
  }

  // Test 2: At 80% - must recommend compression
  monitor.currentUsage = 159000; // 79.5%
  const at80 = monitor.reserve(2000, 'test2'); // Would push to 80.5%
  if (!at80.recommendation || !at80.recommendation.includes('compress')) {
    return { passed: false, error: 'Must recommend compression at 80%' };
  }

  // Test 3: Verify exact command in recommendation
  if (!at80.recommendation.includes('gsd-tools compress')) {
    return { passed: false, error: 'Recommendation must include gsd-tools compress command' };
  }

  return { passed: true, tests: 3 };
}
```

Also verify that the compression system is aware of token state by checking compress status includes token info.
  </action>
  <verify>
```bash
# Run self-test
node -e "
const { TokenBudgetMonitor } = require('/Users/ollorin/.claude/get-shit-done/bin/token-monitor.js');
const result = TokenBudgetMonitor.selfTest();
console.log(JSON.stringify(result, null, 2));
if (!result.passed) {
  console.error('SELF-TEST FAILED:', result.error);
  process.exit(1);
}
console.log('SUCCESS: All integration tests passed');
"

# Verify gap is closed - the exact success criterion from VERIFICATION.md
node -e "
const { TokenBudgetMonitor } = require('/Users/ollorin/.claude/get-shit-done/bin/token-monitor.js');
const monitor = new TokenBudgetMonitor('opus', 200000);
monitor.currentUsage = 160000; // 80%
const result = monitor.reserve(1, 'gap-test');
if (result.recommendation && result.recommendation.includes('compress')) {
  console.log('GAP CLOSED: TokenBudgetMonitor triggers compression recommendations at 80% utilization');
  console.log('Recommendation:', result.recommendation);
} else {
  console.error('GAP NOT CLOSED: Missing compression recommendation');
  process.exit(1);
}
"
```
  </verify>
  <done>End-to-end test confirms TokenBudgetMonitor triggers compression recommendations at exactly 80% utilization</done>
</task>

</tasks>

<verification>
Gap closure verified when:
1. token-monitor.js exists and exports TokenBudgetMonitor
2. gsd-tools.js has working token commands (init, reserve, record, report, reset)
3. At 80% utilization, reserve() includes recommendation to enable compression
4. Recommendation text includes "gsd-tools compress" command reference
5. Self-test passes confirming threshold behavior

Re-run verification:
```bash
node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js verify plan-structure .planning/phases/09-*/09-05-PLAN.md
```
</verification>

<success_criteria>
- [ ] TokenBudgetMonitor class implemented with 80/90/95% thresholds
- [ ] reserve() method returns recommendation at 80%+ utilization
- [ ] Token CLI commands work in gsd-tools.js
- [ ] Recommendation message includes compression enable command
- [ ] Self-test validates threshold behavior
- [ ] Success criterion 7 from 09-VERIFICATION.md satisfied
</success_criteria>

<output>
After completion, create `.planning/phases/09-hook-based-documentation-compression-optimize-context-injection-by-extracting-ai-friendly-headers-from-docs-and-injecting-only-summaries-with-absolute-links-instead-of-full-content/09-05-SUMMARY.md`
</output>
