---
phase: 10-installation-system
plan: 04
type: execute
wave: 3
depends_on: ["10-02", "10-03"]
files_modified:
  - scripts/generate-env-template.js
  - scripts/uninstall.sh
  - .env.template
autonomous: false

must_haves:
  truths:
    - ".env.template contains all required environment variables"
    - "Uninstall script removes GSD files while preserving user data"
    - "Installation completes with clear next steps for user"
    - "User can verify full installation flow end-to-end"
  artifacts:
    - path: "scripts/generate-env-template.js"
      provides: "Environment template generation"
      min_lines: 40
    - path: "scripts/uninstall.sh"
      provides: "Clean uninstall script"
      min_lines: 30
    - path: ".env.template"
      provides: "Environment variable documentation"
      contains: "TELEGRAM_BOT_TOKEN"
  key_links:
    - from: "scripts/install-orchestrator.js"
      to: "scripts/generate-env-template.js"
      via: "require call step 5"
      pattern: "require.*generate-env-template"
    - from: "package.json"
      to: "scripts/uninstall.sh"
      via: "uninstall:gsd script"
      pattern: "uninstall:gsd.*uninstall.sh"
---

<objective>
Create environment template generator, uninstall script, and verify complete installation flow.

Purpose: Provide clear environment setup documentation and clean uninstall capability.
Output: scripts/generate-env-template.js, scripts/uninstall.sh, .env.template, user verification
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-RESEARCH.md
@.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-01-SUMMARY.md
@.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-02-SUMMARY.md
@.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create environment template generator</name>
  <files>
    scripts/generate-env-template.js
    .env.template
  </files>
  <action>
Create script that generates .env.template with all required environment variables.

Required environment variables (from codebase analysis):

1. **Telegram Integration (Phase 8/08.1)**
   - TELEGRAM_BOT_TOKEN: Bot token from @BotFather
   - TELEGRAM_OWNER_ID: User's Telegram ID (for security - only owner receives messages)

2. **API Keys (optional)**
   - ANTHROPIC_API_KEY: Claude API key (only if not using subscription tokens)

3. **Runtime Configuration**
   - NODE_ENV: development | production
   - LOG_LEVEL: debug | info | warn | error

4. **OpenTelemetry (optional, Phase 8)**
   - OTEL_EXPORTER_OTLP_ENDPOINT: Collector endpoint
   - OTEL_SERVICE_NAME: Service name for traces

Script implementation:

```javascript
#!/usr/bin/env node
/**
 * Generate .env.template from required environment variables
 */

const fs = require('fs');
const path = require('path');

const ENV_VARS = [
  {
    name: 'TELEGRAM_BOT_TOKEN',
    required: true,
    description: 'Telegram bot token from @BotFather',
    example: '123456789:ABCdefGHIjklMNOpqrsTUVwxyz'
  },
  {
    name: 'TELEGRAM_OWNER_ID',
    required: true,
    description: 'Your Telegram user ID (send /start to @userinfobot to get it)',
    example: '123456789'
  },
  {
    name: 'ANTHROPIC_API_KEY',
    required: false,
    description: 'Claude API key (optional - only needed if not using Claude Code subscription)',
    example: 'sk-ant-...'
  },
  {
    name: 'NODE_ENV',
    required: false,
    description: 'Runtime environment',
    default: 'development',
    options: ['development', 'production']
  },
  {
    name: 'LOG_LEVEL',
    required: false,
    description: 'Logging verbosity',
    default: 'info',
    options: ['debug', 'info', 'warn', 'error']
  },
  {
    name: 'OTEL_EXPORTER_OTLP_ENDPOINT',
    required: false,
    description: 'OpenTelemetry collector endpoint (optional - for distributed tracing)',
    example: 'http://localhost:4317'
  },
  {
    name: 'OTEL_SERVICE_NAME',
    required: false,
    description: 'Service name for OpenTelemetry traces',
    default: 'gsd'
  }
];

function generateEnvTemplate() {
  const lines = [
    '# GSD Environment Configuration',
    '# Copy this file to .env and fill in your values',
    '# Never commit .env to version control!',
    '',
    '# ========================================',
    '# Required Variables',
    '# ========================================',
    ''
  ];

  // Required vars first
  for (const v of ENV_VARS.filter(v => v.required)) {
    lines.push(`# ${v.description}`);
    if (v.example) lines.push(`# Example: ${v.example}`);
    lines.push(`${v.name}=`);
    lines.push('');
  }

  lines.push('# ========================================');
  lines.push('# Optional Variables');
  lines.push('# ========================================');
  lines.push('');

  // Optional vars
  for (const v of ENV_VARS.filter(v => !v.required)) {
    lines.push(`# ${v.description}`);
    if (v.options) lines.push(`# Options: ${v.options.join(' | ')}`);
    if (v.default) lines.push(`# Default: ${v.default}`);
    if (v.example) lines.push(`# Example: ${v.example}`);
    lines.push(`# ${v.name}=${v.default || ''}`);
    lines.push('');
  }

  const content = lines.join('\n');
  const templatePath = path.join(__dirname, '..', '.env.template');

  fs.writeFileSync(templatePath, content);
  console.log(`       Generated .env.template`);
}

module.exports = generateEnvTemplate;

if (require.main === module) {
  generateEnvTemplate();
}
```

The script generates a commented .env.template that serves as documentation.
  </action>
  <verify>
    node scripts/generate-env-template.js && grep "TELEGRAM_BOT_TOKEN" .env.template
  </verify>
  <done>
    .env.template generated with all required/optional variables, clear descriptions,
    examples, and defaults. Required vs optional clearly separated.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create uninstall script</name>
  <files>
    scripts/uninstall.sh
  </files>
  <action>
Create bash script for clean GSD removal while preserving user data.

Uninstall behavior:

1. **Remove GSD hooks from ~/.claude/hooks/**
   - gsd-statusline.js
   - gsd-check-update.js

2. **Clean MCP config (preserve other servers)**
   - Remove telegram server from .claude/.mcp.json
   - Keep other user-configured servers

3. **Clean settings.json**
   - Remove GSD statusLine if it references our hook
   - Remove GSD hooks from SessionStart

4. **Preserve user data:**
   - .planning/ directory (project state)
   - .env file (user secrets)
   - Whisper models (~/.cache/whisper/) - reusable
   - node_modules (user may have other deps)

5. **Report what was done:**
   - List removed files
   - List preserved directories

Script:
```bash
#!/bin/bash
# GSD Uninstall Script
# Removes GSD files while preserving user data

set -e

echo ""
echo "  GSD Uninstall"
echo ""

HOOKS_DIR="$HOME/.claude/hooks"
CLAUDE_DIR=".claude"
PRESERVED=()

# Remove hooks
if [ -d "$HOOKS_DIR" ]; then
  for hook in gsd-statusline.js gsd-check-update.js; do
    if [ -f "$HOOKS_DIR/$hook" ]; then
      rm -f "$HOOKS_DIR/$hook"
      echo "  - Removed $HOOKS_DIR/$hook"
    fi
  done
fi

# Clean MCP config
MCP_CONFIG="$CLAUDE_DIR/.mcp.json"
if [ -f "$MCP_CONFIG" ]; then
  # Backup first
  cp "$MCP_CONFIG" "$MCP_CONFIG.backup"

  # Remove telegram server (using Node for JSON manipulation)
  node -e "
    const fs = require('fs');
    const config = JSON.parse(fs.readFileSync('$MCP_CONFIG', 'utf8'));
    if (config.mcpServers && config.mcpServers.telegram) {
      delete config.mcpServers.telegram;
      fs.writeFileSync('$MCP_CONFIG', JSON.stringify(config, null, 2));
      console.log('  - Removed telegram MCP server from config');
    }
  " 2>/dev/null || echo "  - Warning: Could not update MCP config"
fi

# Clean settings.json
SETTINGS="$HOME/.claude/settings.json"
if [ -f "$SETTINGS" ]; then
  node -e "
    const fs = require('fs');
    let settings = JSON.parse(fs.readFileSync('$SETTINGS', 'utf8'));
    let modified = false;

    // Remove GSD statusline
    if (settings.statusLine && settings.statusLine.command &&
        settings.statusLine.command.includes('gsd-statusline')) {
      delete settings.statusLine;
      modified = true;
      console.log('  - Removed GSD statusline from settings');
    }

    // Remove GSD hooks
    if (settings.hooks && settings.hooks.SessionStart) {
      const before = settings.hooks.SessionStart.length;
      settings.hooks.SessionStart = settings.hooks.SessionStart.filter(entry => {
        if (entry.hooks && Array.isArray(entry.hooks)) {
          return !entry.hooks.some(h =>
            h.command && h.command.includes('gsd-check-update')
          );
        }
        return true;
      });
      if (settings.hooks.SessionStart.length < before) {
        modified = true;
        console.log('  - Removed GSD hooks from settings');
      }
    }

    if (modified) {
      fs.writeFileSync('$SETTINGS', JSON.stringify(settings, null, 2) + '\\n');
    }
  " 2>/dev/null || echo "  - Warning: Could not update settings.json"
fi

echo ""
echo "  Preserved (your data):"
echo "    - .planning/ (project state)"
echo "    - .env (your secrets)"
echo "    - ~/.cache/whisper/ (reusable models)"
echo ""
echo "  Done! GSD has been uninstalled."
echo ""
```

Make script executable: chmod +x scripts/uninstall.sh
  </action>
  <verify>
    chmod +x scripts/uninstall.sh && bash -n scripts/uninstall.sh && echo "Script syntax valid"
  </verify>
  <done>
    Uninstall script removes GSD hooks, cleans MCP config and settings.json,
    preserves user data (.planning/, .env, Whisper models), reports what was done
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: Verify complete installation flow</name>
  <what-built>
    Complete GSD installation system:
    - npm run install:gsd orchestrates full installation
    - Module stubs created for future implementation
    - Whisper models downloaded automatically
    - Claude Code hooks installed to ~/.claude/
    - MCP server configured in .claude/.mcp.json
    - .env.template generated with all variables
    - Health check validates all components
    - Uninstall script for clean removal
  </what-built>
  <how-to-verify>
    1. From repo root, run: npm run install:gsd
       - Should complete all 6 steps without errors
       - Should report health check results

    2. Verify artifacts created:
       - ls get-shit-done/modules/*/package.json (5 modules)
       - ls ~/.claude/hooks/gsd-*.js (2 hooks)
       - cat .claude/.mcp.json (telegram server)
       - cat .env.template (environment variables)

    3. Verify health check: node scripts/health-check.js
       - All checks should pass or be marked skipped (if optional)

    4. Test npx detection (optional):
       - The orchestrator should detect if running from npx github: context

    5. Test uninstall (optional):
       - npm run uninstall:gsd
       - Verify hooks removed, MCP config cleaned
       - Verify .planning/ preserved

    Expected result: Full installation completes, all health checks pass.
  </how-to-verify>
  <resume-signal>Type "approved" if installation works end-to-end, or describe any issues</resume-signal>
</task>

</tasks>

<verification>
1. Run: npm run install:gsd (complete flow)
2. Run: node scripts/health-check.js (all checks pass)
3. Verify: cat .env.template (contains TELEGRAM_BOT_TOKEN)
4. Verify: bash -n scripts/uninstall.sh (valid syntax)
5. Run: npm run uninstall:gsd (clean removal, preserves data)
</verification>

<success_criteria>
- .env.template documents all required/optional environment variables
- Uninstall script removes GSD while preserving user data
- Full installation flow (npm run install:gsd) completes without errors
- Health check validates all installation components
- User can confidently use GSD after running single install command
</success_criteria>

<output>
After completion, create `.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-04-SUMMARY.md`
</output>
