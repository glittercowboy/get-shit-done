---
phase: 10-installation-system
plan: 02
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - scripts/install-whisper.js
  - scripts/health-check.js
autonomous: true

must_haves:
  truths:
    - "Whisper models are downloaded automatically during installation"
    - "Health check validates all installation components"
    - "Missing Whisper models are detected and re-downloaded"
    - "Health check exits non-zero if any component fails"
  artifacts:
    - path: "scripts/install-whisper.js"
      provides: "Whisper model download automation"
      min_lines: 60
    - path: "scripts/health-check.js"
      provides: "Installation validation"
      min_lines: 80
  key_links:
    - from: "scripts/install-orchestrator.js"
      to: "scripts/install-whisper.js"
      via: "require call step 2"
      pattern: "require.*install-whisper"
    - from: "scripts/install-orchestrator.js"
      to: "scripts/health-check.js"
      via: "require call step 6"
      pattern: "require.*health-check"
---

<objective>
Automate Whisper model download and create comprehensive health check validation.

Purpose: Ensure voice transcription works out-of-box and validate all installation components.
Output: scripts/install-whisper.js, scripts/health-check.js
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-RESEARCH.md
@.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-01-SUMMARY.md
@get-shit-done/bin/whisper-transcribe.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Whisper model installer</name>
  <files>
    scripts/install-whisper.js
  </files>
  <action>
Create Whisper model download automation script.

Implementation requirements:

1. Model selection:
   - Download "base.en" for English (proven in Phase 8/08.1, 244MB)
   - For multilingual support (including Russian), use "base" model instead
   - Per research: base multilingual may cover both languages in single download

2. Model path detection:
   - whisper-node stores models at: ~/.cache/whisper/ggml-{model}.bin
   - Use os.homedir() for cross-platform path resolution

3. Download logic:
   - Check if model already exists before downloading
   - Use whisper-node's built-in download: `npx whisper-node download {model}`
   - Implement retry with exponential backoff (3 attempts)
   - Timeout: 5 minutes minimum for large file download

4. Verification:
   - After download, verify file exists and has non-zero size
   - Report file size for user feedback

5. Error handling:
   - Catch download timeouts, provide manual download instructions as fallback
   - Log to stderr, not stdout (installer output should be clean)
   - Exit gracefully on failure (don't block installation)

Script structure:
```javascript
const MODELS = ['base.en'];  // Start with English only
// For multilingual: const MODELS = ['base'];

async function installWhisperModels() {
  for (const model of MODELS) {
    const modelPath = path.join(os.homedir(), '.cache', 'whisper', `ggml-${model}.bin`);

    if (fs.existsSync(modelPath)) {
      const stats = fs.statSync(modelPath);
      console.log(`       Whisper ${model}: already installed (${(stats.size / 1024 / 1024).toFixed(1)}MB)`);
      continue;
    }

    console.log(`       Downloading Whisper model: ${model}...`);
    // ... download with retry logic
  }
}
```

The script should be both requireable and directly executable (if require.main === module).
  </action>
  <verify>
    node scripts/install-whisper.js && ls ~/.cache/whisper/*.bin
  </verify>
  <done>
    Whisper model installer downloads base.en, verifies installation, provides retry logic,
    and gracefully handles errors with manual download instructions
  </done>
</task>

<task type="auto">
  <name>Task 2: Create comprehensive health check</name>
  <files>
    scripts/health-check.js
  </files>
  <action>
Create installation health check that validates all components.

Health check categories (per research):

1. **NPM Dependencies**
   - Check: node_modules exists and is non-empty
   - Check: mcp-servers/telegram-mcp/node_modules exists (if telegram-mcp enabled)
   - Check: Key dependencies importable (better-sqlite3, telegraf, @xenova/transformers)

2. **Whisper Models**
   - Check: ~/.cache/whisper/ggml-base.en.bin exists
   - Check: File size is reasonable (>100MB for base models)

3. **Claude Code Hooks** (if installed globally)
   - Check: ~/.claude/hooks/gsd-statusline.js exists
   - Check: ~/.claude/hooks/gsd-check-update.js exists

4. **MCP Configuration** (if configured)
   - Check: .claude/.mcp.json exists and is valid JSON
   - Check: telegram server entry exists in mcpServers

5. **Environment Template**
   - Check: .env.template exists
   - Check: Contains required variables (TELEGRAM_BOT_TOKEN, etc.)

6. **Module Imports**
   - Check: get-shit-done/bin/gsd-tools.js importable
   - Check: Module stubs in get-shit-done/modules/* importable

Implementation:

```javascript
async function healthCheck() {
  const checks = [];
  let passed = 0;
  let failed = 0;
  let skipped = 0;

  // Define checks with skip conditions
  checks.push({
    name: 'NPM Dependencies',
    skip: () => false,  // Always check
    test: () => fs.existsSync('node_modules') && fs.readdirSync('node_modules').length > 0
  });

  checks.push({
    name: 'Whisper Models',
    skip: () => !fs.existsSync(path.join(os.homedir(), '.cache', 'whisper')),
    test: () => {
      const modelPath = path.join(os.homedir(), '.cache', 'whisper', 'ggml-base.en.bin');
      if (!fs.existsSync(modelPath)) return false;
      const stats = fs.statSync(modelPath);
      return stats.size > 100 * 1024 * 1024;  // >100MB
    }
  });

  // ... more checks

  // Run checks
  for (const check of checks) {
    if (check.skip && check.skip()) {
      console.log(`  - ${check.name} (skipped)`);
      skipped++;
      continue;
    }

    try {
      const result = check.test();
      if (result) {
        console.log(`  + ${check.name}`);
        passed++;
      } else {
        console.log(`  x ${check.name}`);
        failed++;
      }
    } catch (e) {
      console.log(`  x ${check.name} (error: ${e.message})`);
      failed++;
    }
  }

  console.log(`\n  ${passed} passed, ${failed} failed, ${skipped} skipped\n`);

  if (failed > 0) {
    console.error('  Installation incomplete. Re-run: npm run install:gsd');
    process.exit(1);
  }

  console.log('  Installation validated successfully');
}
```

The script must exit with code 1 if any required check fails (not skipped checks).
  </action>
  <verify>
    node scripts/health-check.js && echo "Health check passed"
  </verify>
  <done>
    Health check validates: npm deps, whisper models, hooks (if global), MCP config (if exists),
    env template, module imports. Exits non-zero on failure with clear error messages.
  </done>
</task>

</tasks>

<verification>
1. Run: node scripts/install-whisper.js (downloads model or confirms existing)
2. Run: node scripts/health-check.js (reports all checks)
3. Verify: Health check detects missing components correctly
4. Run: npm run install:gsd (full flow completes steps 2 and 6)
</verification>

<success_criteria>
- Whisper base.en model downloads automatically during installation
- Model download includes retry logic and timeout handling
- Health check validates all 6 component categories
- Health check exits non-zero if required components missing
- Both scripts integrate with install-orchestrator.js
</success_criteria>

<output>
After completion, create `.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-02-SUMMARY.md`
</output>
