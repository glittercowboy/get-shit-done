---
phase: 10-installation-system
plan: 03
type: execute
wave: 2
depends_on: ["10-01"]
files_modified:
  - scripts/install-hooks.js
  - scripts/install-mcp.js
autonomous: true

must_haves:
  truths:
    - "Claude Code hooks install to ~/.claude/hooks/ automatically"
    - "MCP server configuration merges with existing .mcp.json"
    - "User's existing MCP servers are preserved during install"
    - "Hooks work on macOS and Linux without modification"
  artifacts:
    - path: "scripts/install-hooks.js"
      provides: "Hook installation to ~/.claude/"
      min_lines: 60
    - path: "scripts/install-mcp.js"
      provides: "MCP server configuration merge"
      min_lines: 50
  key_links:
    - from: "scripts/install-orchestrator.js"
      to: "scripts/install-hooks.js"
      via: "require call step 3"
      pattern: "require.*install-hooks"
    - from: "scripts/install-orchestrator.js"
      to: "scripts/install-mcp.js"
      via: "require call step 4"
      pattern: "require.*install-mcp"
---

<objective>
Create hook installation and MCP server configuration scripts.

Purpose: Automate Claude Code hook installation and MCP config setup with safe merge strategy.
Output: scripts/install-hooks.js, scripts/install-mcp.js
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-RESEARCH.md
@.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-01-SUMMARY.md
@bin/install.js
@hooks/gsd-statusline.js
@hooks/gsd-check-update.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create hook installation script</name>
  <files>
    scripts/install-hooks.js
  </files>
  <action>
Create script to install Claude Code hooks, adapting patterns from bin/install.js (lines 1408-1426).

Requirements:

1. **Source hooks from hooks/dist/**
   - Bundled hooks are at hooks/dist/ (after npm run build:hooks)
   - Source hooks are at hooks/ (raw .js files)
   - Prefer dist/ if exists, fall back to source

2. **Destination: ~/.claude/hooks/**
   - Use os.homedir() + '.claude/hooks' for cross-platform
   - Create directory with { recursive: true }

3. **Hook files to install:**
   - gsd-statusline.js (status bar display)
   - gsd-check-update.js (version check on session start)

4. **Settings.json configuration:**
   - Read existing ~/.claude/settings.json
   - Configure statusLine to point to gsd-statusline.js
   - Add SessionStart hook for gsd-check-update.js
   - MERGE, don't overwrite (preserve user's other hooks)

5. **Path handling:**
   - Use forward slashes in hook commands for cross-platform (bin/install.js line 173)
   - Example: `node "/Users/name/.claude/hooks/gsd-statusline.js"`.replace(/\\/g, '/')

6. **Existing hook detection:**
   - If user has existing statusLine, skip unless --force-statusline flag
   - Log what's being installed

Script structure:
```javascript
function installHooks(options = {}) {
  const configDir = path.join(os.homedir(), '.claude');
  const hooksDir = path.join(configDir, 'hooks');

  // Find source hooks
  const distDir = path.join(__dirname, '..', 'hooks', 'dist');
  const srcDir = path.join(__dirname, '..', 'hooks');
  const hooksSrc = fs.existsSync(distDir) ? distDir : srcDir;

  // Create destination
  fs.mkdirSync(hooksDir, { recursive: true });

  // Copy hooks
  const hooks = ['gsd-statusline.js', 'gsd-check-update.js'];
  for (const hook of hooks) {
    const src = path.join(hooksSrc, hook);
    if (!fs.existsSync(src)) {
      console.log(`       Warning: ${hook} not found in source`);
      continue;
    }
    const dest = path.join(hooksDir, hook);
    fs.copyFileSync(src, dest);
    console.log(`       Installed ${hook}`);
  }

  // Configure settings.json
  configureSettings(configDir, hooksDir, options);
}

function configureSettings(configDir, hooksDir, options) {
  const settingsPath = path.join(configDir, 'settings.json');
  let settings = {};

  if (fs.existsSync(settingsPath)) {
    try {
      settings = JSON.parse(fs.readFileSync(settingsPath, 'utf8'));
    } catch (e) {
      console.log(`       Warning: Could not parse settings.json`);
    }
  }

  // Configure statusLine (skip if exists unless force)
  const statuslineCommand = `node "${hooksDir.replace(/\\/g, '/')}/gsd-statusline.js"`;
  if (!settings.statusLine || options.forceStatusline) {
    settings.statusLine = { type: 'command', command: statuslineCommand };
    console.log(`       Configured statusline`);
  } else {
    console.log(`       Skipped statusline (already configured)`);
  }

  // Configure SessionStart hook for update check
  if (!settings.hooks) settings.hooks = {};
  if (!settings.hooks.SessionStart) settings.hooks.SessionStart = [];

  const updateCommand = `node "${hooksDir.replace(/\\/g, '/')}/gsd-check-update.js"`;
  const hasUpdateHook = settings.hooks.SessionStart.some(entry =>
    entry.hooks?.some(h => h.command?.includes('gsd-check-update'))
  );

  if (!hasUpdateHook) {
    settings.hooks.SessionStart.push({
      hooks: [{ type: 'command', command: updateCommand }]
    });
    console.log(`       Configured update check hook`);
  }

  fs.writeFileSync(settingsPath, JSON.stringify(settings, null, 2) + '\n');
}
```

The script should be idempotent - safe to run multiple times.
  </action>
  <verify>
    node scripts/install-hooks.js && ls ~/.claude/hooks/gsd-*.js
  </verify>
  <done>
    Hook installer copies hooks to ~/.claude/hooks/, configures settings.json with statusLine
    and SessionStart hook, preserves existing user configuration, handles cross-platform paths
  </done>
</task>

<task type="auto">
  <name>Task 2: Create MCP server configuration script</name>
  <files>
    scripts/install-mcp.js
  </files>
  <action>
Create script to configure MCP servers with safe merge strategy.

Requirements:

1. **Target file: .claude/.mcp.json (project-specific)**
   - Per research: prioritize project-specific over global
   - Create .claude/ directory if needed

2. **GSD MCP servers to configure:**
   - telegram: Telegram MCP server for blocking questions
   ```json
   {
     "telegram": {
       "command": "node",
       "args": ["mcp-servers/telegram-mcp/dist/index.js"],
       "env": {
         "TELEGRAM_BOT_TOKEN": "${TELEGRAM_BOT_TOKEN}",
         "TELEGRAM_OWNER_ID": "${TELEGRAM_OWNER_ID}"
       }
     }
   }
   ```

3. **Merge strategy (CRITICAL):**
   - Read existing .mcp.json if present
   - Backup to .mcp.json.backup before modifying
   - Merge GSD servers INTO existing config
   - User's servers take precedence (don't overwrite if same name)
   - Preserve mcpServers structure

4. **Atomic write pattern:**
   - Write to .mcp.json.tmp first
   - Rename to .mcp.json (atomic on POSIX)
   - This prevents corruption if Claude Code reads during write

5. **Validation:**
   - Verify result is valid JSON before writing
   - Report what was added vs what was skipped

Script structure:
```javascript
function installMcp() {
  const projectRoot = path.resolve(__dirname, '..');
  const configDir = path.join(projectRoot, '.claude');
  const mcpPath = path.join(configDir, '.mcp.json');

  fs.mkdirSync(configDir, { recursive: true });

  // GSD servers to install
  const gsdServers = {
    telegram: {
      command: 'node',
      args: ['mcp-servers/telegram-mcp/dist/index.js'],
      env: {
        TELEGRAM_BOT_TOKEN: '${TELEGRAM_BOT_TOKEN}',
        TELEGRAM_OWNER_ID: '${TELEGRAM_OWNER_ID}'
      }
    }
  };

  // Load existing config
  let existing = { mcpServers: {} };
  if (fs.existsSync(mcpPath)) {
    try {
      const content = fs.readFileSync(mcpPath, 'utf8');
      existing = JSON.parse(content);
      // Backup
      fs.copyFileSync(mcpPath, `${mcpPath}.backup`);
    } catch (e) {
      console.log(`       Warning: Could not parse existing .mcp.json`);
      console.log(`       Creating new config...`);
    }
  }

  // Merge (GSD defaults, user overwrites)
  const merged = {
    ...existing,
    mcpServers: {
      ...gsdServers,
      ...(existing.mcpServers || {})  // User servers take precedence
    }
  };

  // Validate before write
  const jsonString = JSON.stringify(merged, null, 2);
  try {
    JSON.parse(jsonString);  // Validate
  } catch (e) {
    throw new Error('Generated invalid JSON - aborting');
  }

  // Atomic write
  const tmpPath = `${mcpPath}.tmp`;
  fs.writeFileSync(tmpPath, jsonString + '\n');
  fs.renameSync(tmpPath, mcpPath);

  // Report
  const added = Object.keys(gsdServers).filter(k => !existing.mcpServers?.[k]);
  const skipped = Object.keys(gsdServers).filter(k => existing.mcpServers?.[k]);

  if (added.length > 0) {
    console.log(`       Added MCP servers: ${added.join(', ')}`);
  }
  if (skipped.length > 0) {
    console.log(`       Skipped (already configured): ${skipped.join(', ')}`);
  }
}
```

The script should be idempotent and safe to run multiple times.
  </action>
  <verify>
    node scripts/install-mcp.js && cat .claude/.mcp.json | node -e "JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8'))" && echo "Valid JSON"
  </verify>
  <done>
    MCP installer creates/updates .claude/.mcp.json with telegram server config,
    merges with existing config (user servers preserved), uses atomic write,
    creates backup before modification
  </done>
</task>

</tasks>

<verification>
1. Run: node scripts/install-hooks.js (hooks installed, settings.json updated)
2. Run: node scripts/install-mcp.js (mcp.json created/merged)
3. Verify: ls ~/.claude/hooks/gsd-*.js (hooks exist)
4. Verify: cat .claude/.mcp.json (telegram server configured)
5. Run: npm run install:gsd (steps 3 and 4 complete without errors)
</verification>

<success_criteria>
- Hooks install to ~/.claude/hooks/ with proper permissions
- settings.json configured with statusLine and SessionStart hook
- MCP config merges safely, preserving user's existing servers
- Backup created before .mcp.json modification
- Scripts are idempotent (safe to run multiple times)
</success_criteria>

<output>
After completion, create `.planning/phases/10-module-repository-consolidation-move-external-modules-validator-circuit-breaker-escalation-feedback-learning-into-repo-with-installation-script-and-proper-structure/10-03-SUMMARY.md`
</output>
