---
phase: 05-knowledge-permissions-safety
plan: 05
type: execute
wave: 2
depends_on: []
files_modified:
  - get-shit-done/bin/knowledge-feedback.js
  - get-shit-done/bin/knowledge-crud.js
autonomous: true

must_haves:
  truths:
    - "User can mark a principle as wrong with severity level"
    - "Confidence degrades based on severity (minor: 20%, major: 50%, critical: 100%)"
    - "Principles with confidence < 0.3 are marked invalidated"
    - "User can mark principle as outdated with optional replacement"
  artifacts:
    - path: "get-shit-done/bin/knowledge-feedback.js"
      provides: "Principle feedback and invalidation"
      exports: ["markPrincipleWrong", "markPrincipleOutdated", "getPrincipleFeedbackHistory"]
  key_links:
    - from: "get-shit-done/bin/knowledge-feedback.js"
      to: "get-shit-done/bin/knowledge-crud.js"
      via: "updateKnowledge for metadata updates"
      pattern: "updateKnowledge"
---

<objective>
Create feedback loop for principle invalidation

Purpose: Implement KNOW-26 (mark wrong/outdated) and KNOW-27 (learn from feedback). Users can provide negative feedback on principles, causing confidence degradation or invalidation.

Output: knowledge-feedback.js module with principle feedback functions
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-knowledge-permissions-safety/05-RESEARCH.md
@get-shit-done/bin/knowledge-crud.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create principle feedback module</name>
  <files>get-shit-done/bin/knowledge-feedback.js</files>
  <action>
Create knowledge-feedback.js with:

1. **DEGRADATION_FACTORS constant:**
```javascript
const DEGRADATION_FACTORS = {
  critical: 1.0,   // Invalidate immediately (confidence -> 0)
  major: 0.5,      // Cut confidence in half
  minor: 0.2       // Reduce by 20%
};
```

2. **markPrincipleWrong(db, principleId, feedback = {})** - Mark as wrong
   - Extract severity from feedback (default: 'minor')
   - Get current principle: SELECT * FROM knowledge WHERE id = ?
   - If not found: return { success: false, error: 'principle_not_found' }
   - Parse metadata, get current confidence (default: 0.7)
   - Calculate new confidence: currentConfidence * (1 - DEGRADATION_FACTORS[severity])
   - Update metadata with:
     - confidence: newConfidence
     - feedback_count: (meta.feedback_count || 0) + 1
     - last_feedback: Date.now()
     - last_feedback_reason: feedback.reason
     - last_feedback_severity: severity
   - If newConfidence < 0.3: add invalidated: true, invalidated_at: Date.now()
   - UPDATE knowledge SET metadata = ? WHERE id = ?
   - Return { success: true, old_confidence, new_confidence, invalidated: newConfidence < 0.3 }

3. **markPrincipleOutdated(db, principleId, options = {})** - Mark as outdated
   - Get current principle
   - Parse metadata
   - Update metadata with:
     - outdated: true
     - outdated_at: Date.now()
     - replaced_by: options.replacement (if provided)
     - confidence: 0.0
   - Set expires_at to 7 days from now (soft delete)
   - Return { success: true, outdated: true, expires_at }

4. **getPrincipleMetadata(db, principleId)** - Helper to get parsed metadata
   - SELECT metadata FROM knowledge WHERE id = ?
   - Return JSON.parse(metadata) or {}

Export: DEGRADATION_FACTORS, markPrincipleWrong, markPrincipleOutdated, getPrincipleMetadata
  </action>
  <verify>
Run:
```bash
node -e "
const { openKnowledgeDB } = require('./get-shit-done/bin/knowledge-db.js');
const { insertKnowledge } = require('./get-shit-done/bin/knowledge-crud.js');
const { markPrincipleWrong } = require('./get-shit-done/bin/knowledge-feedback.js');
const conn = openKnowledgeDB('project');
const id = insertKnowledge(conn.db, { content: 'Test principle', type: 'principle', metadata: { confidence: 0.8 } });
const result1 = markPrincipleWrong(conn.db, id, { severity: 'minor', reason: 'Did not work' });
console.log('After minor:', result1.new_confidence.toFixed(2)); // 0.64
const result2 = markPrincipleWrong(conn.db, id, { severity: 'major' });
console.log('After major:', result2.new_confidence.toFixed(2)); // 0.32
const result3 = markPrincipleWrong(conn.db, id, { severity: 'minor' });
console.log('After another minor:', result3.new_confidence.toFixed(2), 'Invalidated:', result3.invalidated);
"
```
Should show degrading confidence and eventual invalidation
  </verify>
  <done>Principle feedback module with confidence degradation and invalidation</done>
</task>

<task type="auto">
  <name>Task 2: Add feedback history tracking</name>
  <files>get-shit-done/bin/knowledge-feedback.js</files>
  <action>
Add feedback history functions:

1. **recordFeedbackEvent(db, principleId, event)** - Store feedback event
   - Create feedback_history table if not exists:
   ```sql
   CREATE TABLE IF NOT EXISTS feedback_history (
     id INTEGER PRIMARY KEY AUTOINCREMENT,
     principle_id INTEGER NOT NULL,
     event_type TEXT NOT NULL,
     severity TEXT,
     reason TEXT,
     old_confidence REAL,
     new_confidence REAL,
     created_at INTEGER NOT NULL,
     FOREIGN KEY (principle_id) REFERENCES knowledge(id)
   );
   ```
   - INSERT event record
   - Return { recorded: true, event_id }

2. **getPrincipleFeedbackHistory(db, principleId)** - Get feedback history
   - SELECT * FROM feedback_history WHERE principle_id = ? ORDER BY created_at DESC
   - Return array of events

3. **Update markPrincipleWrong and markPrincipleOutdated** to call recordFeedbackEvent
   - Record event with old_confidence, new_confidence, reason, severity

4. **getInvalidatedPrinciples(db)** - List all invalidated principles
   - SELECT * FROM knowledge WHERE type = 'principle' AND JSON_EXTRACT(metadata, '$.invalidated') = 1
   - Return array of invalidated principles

Export: recordFeedbackEvent, getPrincipleFeedbackHistory, getInvalidatedPrinciples
  </action>
  <verify>
Run:
```bash
node -e "
const { openKnowledgeDB } = require('./get-shit-done/bin/knowledge-db.js');
const { insertKnowledge } = require('./get-shit-done/bin/knowledge-crud.js');
const { markPrincipleWrong, getPrincipleFeedbackHistory } = require('./get-shit-done/bin/knowledge-feedback.js');
const conn = openKnowledgeDB('project');
const id = insertKnowledge(conn.db, { content: 'Another test', type: 'principle', metadata: { confidence: 0.9 } });
markPrincipleWrong(conn.db, id, { severity: 'minor', reason: 'Test 1' });
markPrincipleWrong(conn.db, id, { severity: 'major', reason: 'Test 2' });
const history = getPrincipleFeedbackHistory(conn.db, id);
console.log('History length:', history.length);
console.log('Events:', history.map(h => h.event_type + ':' + h.severity).join(', '));
"
```
Should show history with 2 events
  </verify>
  <done>Feedback history tracking with event recording and retrieval</done>
</task>

<task type="auto">
  <name>Task 3: Add replacement principle workflow</name>
  <files>get-shit-done/bin/knowledge-feedback.js</files>
  <action>
Add principle replacement functions:

1. **promptForReplacement(principleContent)** - Generate replacement prompt
   - Return: "Principle '{content}' was marked wrong. What should I do instead?"
   - This is used by CLI to show user prompt

2. **createReplacementPrinciple(db, oldPrincipleId, newContent, options = {})** - Create replacement
   - Get old principle metadata
   - Insert new principle with:
     - type: 'principle'
     - content: newContent
     - metadata: { replaces: oldPrincipleId, confidence: options.confidence || 0.7 }
   - Update old principle metadata with replaced_by: newPrincipleId
   - Return { created: true, old_id: oldPrincipleId, new_id, old_content, new_content }

3. **getReplacementChain(db, principleId)** - Get chain of replacements
   - Follow replaced_by links
   - Return array from oldest to newest
   - Useful for understanding principle evolution

4. **getPendingReplacements(db)** - Get principles marked wrong but not yet replaced
   - SELECT * FROM knowledge WHERE type = 'principle' AND JSON_EXTRACT(metadata, '$.invalidated') = 1 AND JSON_EXTRACT(metadata, '$.replaced_by') IS NULL
   - Return array

Export: promptForReplacement, createReplacementPrinciple, getReplacementChain, getPendingReplacements
  </action>
  <verify>
Run:
```bash
node -e "
const { openKnowledgeDB } = require('./get-shit-done/bin/knowledge-db.js');
const { insertKnowledge } = require('./get-shit-done/bin/knowledge-crud.js');
const { markPrincipleWrong, createReplacementPrinciple, getReplacementChain } = require('./get-shit-done/bin/knowledge-feedback.js');
const conn = openKnowledgeDB('project');
const id = insertKnowledge(conn.db, { content: 'Old way', type: 'principle', metadata: { confidence: 0.8 } });
markPrincipleWrong(conn.db, id, { severity: 'critical', reason: 'Completely wrong' });
const replacement = createReplacementPrinciple(conn.db, id, 'New better way', { confidence: 0.9 });
console.log('Created replacement:', replacement.new_id);
const chain = getReplacementChain(conn.db, id);
console.log('Chain length:', chain.length);
"
```
Should create replacement and show chain
  </verify>
  <done>Replacement principle workflow with chain tracking</done>
</task>

</tasks>

<verification>
1. markPrincipleWrong degrades confidence correctly per severity
2. Principles with confidence < 0.3 are invalidated
3. markPrincipleOutdated sets expires_at and confidence = 0
4. Feedback events are recorded with full history
5. Replacement principles link to originals
6. Replacement chain can be followed
</verification>

<success_criteria>
- Confidence degrades: minor 20%, major 50%, critical 100%
- Invalidation triggers at confidence < 0.3
- Outdated principles soft-delete in 7 days
- Feedback history preserved for audit
- Replacement workflow creates linked principles
- Module exports all required functions
</success_criteria>

<output>
After completion, create `.planning/phases/05-knowledge-permissions-safety/05-05-SUMMARY.md`
</output>
