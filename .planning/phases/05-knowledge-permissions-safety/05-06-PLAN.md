---
phase: 05-knowledge-permissions-safety
plan: 06
type: execute
wave: 3
depends_on: ["05-01", "05-02", "05-03", "05-04", "05-05"]
files_modified:
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/bin/knowledge-safety.js
autonomous: true

must_haves:
  truths:
    - "User can grant permissions via CLI command"
    - "User can revoke permissions via CLI command"
    - "User can list active permissions"
    - "Emergency stop pauses all costly/external actions"
    - "Safety checks integrate with execute-plan workflow"
  artifacts:
    - path: "get-shit-done/bin/gsd-tools.js"
      provides: "CLI commands for permission management"
      contains: "case 'grant':"
  key_links:
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "get-shit-done/bin/knowledge-permissions.js"
      via: "grantPermission, revokePermission, listActivePermissions"
      pattern: "require.*knowledge-permissions"
    - from: "get-shit-done/bin/gsd-tools.js"
      to: "get-shit-done/bin/knowledge-cost.js"
      via: "enableCircuitBreaker, disableCircuitBreaker"
      pattern: "require.*knowledge-cost"
---

<objective>
Create CLI commands and workflow integration

Purpose: Provide user-facing commands for permission management (/gsd:grant, /gsd:revoke, /gsd:list-permissions), emergency stop capability, and integrate safety checks into execute-plan workflow.

Output: CLI commands in gsd-tools.js, updated safety module with full integration
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-knowledge-permissions-safety/05-RESEARCH.md
@get-shit-done/bin/gsd-tools.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add permission CLI commands to gsd-tools</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add permission management commands to gsd-tools.js:

1. **grant command** - Grant a permission
   - Usage: `node gsd-tools.js grant <action> [--scope project|global] [--ttl 7d] [--max-cost 20] [--max-count 100] [--path /test/*]`
   - Parse arguments: action (required), scope (default: project), ttl, limits
   - parseDuration(ttl) converts "7d", "24h", "2w" to milliseconds
   - Call grantPermission(db, { action, scope, limits, ttl })
   - Output: JSON with grant_token and expiration

2. **revoke command** - Revoke a permission
   - Usage: `node gsd-tools.js revoke <token>`
   - Call revokePermission(db, token)
   - Output: JSON with success status

3. **list-permissions command** - List active permissions
   - Usage: `node gsd-tools.js list-permissions [--scope project|global] [--json]`
   - Call listActivePermissions(db)
   - Output: Table or JSON format

4. **parseDuration(str)** helper function
   - Match /^(\d+)([hdw])$/
   - h = hours, d = days, w = weeks
   - Return milliseconds

Add cases to main switch statement. Use lazy require for knowledge modules.
  </action>
  <verify>
Run:
```bash
node get-shit-done/bin/gsd-tools.js grant 'delete_file:/test/*' --ttl 1d --max-count 5
node get-shit-done/bin/gsd-tools.js list-permissions --json | head -20
```
Should show grant output with token and list permissions
  </verify>
  <done>Permission CLI commands with grant, revoke, list-permissions</done>
</task>

<task type="auto">
  <name>Task 2: Add emergency stop commands</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add emergency stop commands to gsd-tools.js:

1. **pause command** - Enable circuit breaker (emergency stop)
   - Usage: `node gsd-tools.js pause [--reason "text"]`
   - Call enableCircuitBreaker(db, reason || 'user_requested')
   - Output: "Emergency stop enabled. Costly and external actions will be blocked."

2. **resume command** - Disable circuit breaker
   - Usage: `node gsd-tools.js resume`
   - Call disableCircuitBreaker(db)
   - Output: "Emergency stop disabled. Normal operation resumed."

3. **status command update** - Show circuit breaker state
   - Add circuit breaker status to existing quota status output
   - Show: "Circuit Breaker: ENABLED (reason: budget_exceeded)" or "DISABLED"

4. **budget command** - Show current spending
   - Usage: `node gsd-tools.js budget [--period daily|weekly]`
   - Call getTotalCost(db, period) and getBudgetLimit(period)
   - Output: "Spent: $X.XX / $Y.YY (ZZ%)"
   - Show alert status: "Alerts fired: 50%, 80%"

Add cases to main switch statement.
  </action>
  <verify>
Run:
```bash
node get-shit-done/bin/gsd-tools.js pause --reason "testing"
node get-shit-done/bin/gsd-tools.js budget --period daily
node get-shit-done/bin/gsd-tools.js resume
```
Should show pause/resume messages and budget status
  </verify>
  <done>Emergency stop and budget CLI commands</done>
</task>

<task type="auto">
  <name>Task 3: Add feedback CLI commands</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add principle feedback commands to gsd-tools.js:

1. **mark-wrong command** - Mark principle as wrong
   - Usage: `node gsd-tools.js mark-wrong <principle-id> [--severity minor|major|critical] [--reason "text"]`
   - Call markPrincipleWrong(db, id, { severity, reason })
   - Output: JSON with old_confidence, new_confidence, invalidated

2. **mark-outdated command** - Mark principle as outdated
   - Usage: `node gsd-tools.js mark-outdated <principle-id> [--replacement "new content"]`
   - If replacement provided: Call createReplacementPrinciple after markPrincipleOutdated
   - Output: JSON with outdated status and replacement_id if created

3. **principle-history command** - Show feedback history
   - Usage: `node gsd-tools.js principle-history <principle-id>`
   - Call getPrincipleFeedbackHistory(db, id)
   - Output: Table of feedback events

4. **pending-replacements command** - Show principles needing replacement
   - Usage: `node gsd-tools.js pending-replacements`
   - Call getPendingReplacements(db)
   - Output: List of invalidated principles without replacements

Add cases to main switch statement.
  </action>
  <verify>
Run:
```bash
node -e "
const { openKnowledgeDB } = require('./get-shit-done/bin/knowledge-db.js');
const { insertKnowledge } = require('./get-shit-done/bin/knowledge-crud.js');
const conn = openKnowledgeDB('project');
const id = insertKnowledge(conn.db, { content: 'Test for CLI', type: 'principle', metadata: { confidence: 0.8 } });
console.log('Created principle:', id);
"
# Then run:
node get-shit-done/bin/gsd-tools.js mark-wrong <id> --severity minor --reason "Testing CLI"
node get-shit-done/bin/gsd-tools.js principle-history <id>
```
Should show feedback recorded and history
  </verify>
  <done>Principle feedback CLI commands with mark-wrong, mark-outdated, history</done>
</task>

</tasks>

<verification>
1. Grant command creates permissions with correct limits and TTL
2. Revoke command invalidates permissions by token
3. List-permissions shows active grants with expiration
4. Pause command enables circuit breaker
5. Resume command disables circuit breaker
6. Budget command shows spending and alerts
7. Mark-wrong degrades confidence correctly
8. Mark-outdated sets expiration and optional replacement
9. All commands work for both project and global scope
</verification>

<success_criteria>
- Permission management via CLI (grant/revoke/list)
- Emergency stop via pause/resume commands
- Budget monitoring via budget command
- Principle feedback via mark-wrong/mark-outdated
- All commands output JSON for programmatic use
- Commands integrate with existing gsd-tools patterns
</success_criteria>

<output>
After completion, create `.planning/phases/05-knowledge-permissions-safety/05-06-SUMMARY.md`
</output>
