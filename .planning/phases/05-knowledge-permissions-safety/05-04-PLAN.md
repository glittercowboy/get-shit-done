---
phase: 05-knowledge-permissions-safety
plan: 04
type: execute
wave: 2
depends_on: []
files_modified:
  - get-shit-done/bin/knowledge-conflicts.js
  - .planning/knowledge/permissions-config.json
autonomous: true

must_haves:
  truths:
    - "Conflicting principles are detected when multiple apply"
    - "Principles are resolved using priority weights"
    - "User can configure priority order via config file"
    - "Ambiguous conflicts (< 20% gap) escalate to user"
  artifacts:
    - path: "get-shit-done/bin/knowledge-conflicts.js"
      provides: "Principle conflict resolution"
      exports: ["resolvePrincipleConflict", "loadUserPriorities", "DEFAULT_PRIORITIES"]
    - path: ".planning/knowledge/permissions-config.json"
      provides: "User-configurable priority weights"
      contains: "priorities"
  key_links:
    - from: "get-shit-done/bin/knowledge-conflicts.js"
      to: ".planning/knowledge/permissions-config.json"
      via: "loadUserPriorities reads config file"
      pattern: "permissions-config.json"
---

<objective>
Create principle conflict resolution with priority matrix

Purpose: Implement KNOW-25 - when multiple principles apply to a decision, resolve conflict using user-defined priority rules (safety > security > reliability > speed > cost > convenience).

Output: knowledge-conflicts.js module with priority-based conflict resolution, default config file template
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-knowledge-permissions-safety/05-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create conflict resolution module</name>
  <files>get-shit-done/bin/knowledge-conflicts.js</files>
  <action>
Create knowledge-conflicts.js with:

1. **DEFAULT_PRIORITIES constant:**
```javascript
const DEFAULT_PRIORITIES = {
  safety: 1.0,
  security: 0.9,
  reliability: 0.85,
  speed: 0.6,
  cost: 0.5,
  convenience: 0.3
};
```

2. **loadUserPriorities()** - Load from config
   - Try to read .planning/knowledge/permissions-config.json
   - If exists and has priorities key, return priorities object
   - Fall back to DEFAULT_PRIORITIES
   - Use try/catch for graceful handling of missing/invalid file

3. **scorePrinciple(principle, priorities)** - Calculate priority score
   - Get category from principle.metadata.category (default: 'convenience')
   - Get priority weight from priorities[category] (default: 0.5)
   - confidence = principle.metadata?.confidence || principle.confidence || 0.7
   - score = confidence * priority
   - Return { ...principle, priority, score, category }

4. **resolvePrincipleConflict(principles, context = {})** - Main resolver
   - Load priorities via loadUserPriorities()
   - Score each principle via scorePrinciple()
   - Sort by score descending
   - If only one principle: return { resolved: true, chosen: scored[0] }
   - If top two scores within 20%: return { resolved: false, reason: 'ambiguous_priority', top_choices: [top2], message }
   - Otherwise: return { resolved: true, chosen: scored[0], alternatives: scored.slice(1, 3), reasoning }

5. **validatePriorities(priorities)** - Check for conflicts
   - Ensure all values are 0-1
   - Warn if same priority for multiple categories (can cause ambiguity)
   - Return { valid: boolean, warnings: [] }

Export: DEFAULT_PRIORITIES, loadUserPriorities, resolvePrincipleConflict, scorePrinciple, validatePriorities
  </action>
  <verify>
Run:
```bash
node -e "
const { resolvePrincipleConflict, DEFAULT_PRIORITIES } = require('./get-shit-done/bin/knowledge-conflicts.js');
const principles = [
  { id: 1, content: 'Use caching for speed', metadata: { category: 'speed', confidence: 0.8 } },
  { id: 2, content: 'Avoid caching sensitive data', metadata: { category: 'security', confidence: 0.9 } }
];
const result = resolvePrincipleConflict(principles);
console.log('Resolved:', result.resolved);
console.log('Chosen:', result.chosen?.content);
console.log('Score:', result.chosen?.score);
"
```
Should resolve to security principle (0.9 * 0.9 = 0.81 > 0.8 * 0.6 = 0.48)
  </verify>
  <done>Conflict resolution module with priority-weighted scoring and ambiguity detection</done>
</task>

<task type="auto">
  <name>Task 2: Create default permissions config</name>
  <files>.planning/knowledge/permissions-config.json</files>
  <action>
Create .planning/knowledge/permissions-config.json with default configuration:

```json
{
  "version": 1,
  "budget": {
    "daily": 5.0,
    "weekly": 25.0,
    "alert_thresholds": [0.5, 0.8, 0.9, 1.0]
  },
  "priorities": {
    "safety": 1.0,
    "security": 0.9,
    "reliability": 0.85,
    "speed": 0.6,
    "cost": 0.5,
    "convenience": 0.3
  },
  "defaults": {
    "permission_ttl_days": 7,
    "max_active_grants": 100,
    "circuit_breaker_enabled": true
  },
  "allowlist": {
    "safe_actions": [
      "read_file:*",
      "run_test:*",
      "format_code",
      "lint",
      "install_package:dev"
    ]
  }
}
```

Create the directory if it doesn't exist: .planning/knowledge/
  </action>
  <verify>
Run:
```bash
cat .planning/knowledge/permissions-config.json | node -e "const config = JSON.parse(require('fs').readFileSync('/dev/stdin', 'utf8')); console.log('Version:', config.version); console.log('Safety priority:', config.priorities.safety); console.log('Daily budget:', config.budget.daily);"
```
Should show: Version: 1, Safety priority: 1, Daily budget: 5
  </verify>
  <done>Default permissions config file with budget, priorities, and allowlist</done>
</task>

<task type="auto">
  <name>Task 3: Add allowlist checking</name>
  <files>get-shit-done/bin/knowledge-conflicts.js</files>
  <action>
Add allowlist functions to knowledge-conflicts.js:

1. **loadAllowlist()** - Load safe actions list
   - Read from permissions-config.json
   - Return config.allowlist?.safe_actions || []

2. **isAllowlisted(action)** - Check if action is pre-approved
   - Get allowlist via loadAllowlist()
   - For each pattern in allowlist:
     - Check exact match or wildcard match (same as matchesPattern in permissions)
   - Return { allowed: boolean, pattern?: string }

3. **matchesAllowlistPattern(action, pattern)** - Pattern matching
   - Exact match
   - Wildcard suffix (:*)
   - Return boolean

4. **loadConfig()** - Helper to load full config
   - Cache config in module variable for performance
   - Reset cache every 60 seconds (config reload)
   - Return parsed config or defaults

Export: loadAllowlist, isAllowlisted, loadConfig
  </action>
  <verify>
Run:
```bash
node -e "
const { isAllowlisted } = require('./get-shit-done/bin/knowledge-conflicts.js');
console.log('read_file test:', isAllowlisted('read_file:src/main.js'));
console.log('run_test unit:', isAllowlisted('run_test:unit'));
console.log('lint:', isAllowlisted('lint'));
console.log('delete_file:', isAllowlisted('delete_file:important.txt'));
"
```
Should show: allowed: true for first three, allowed: false for delete
  </verify>
  <done>Allowlist checking with pattern matching and config loading</done>
</task>

</tasks>

<verification>
1. Priority scores calculate correctly (confidence * priority weight)
2. Conflict resolution picks highest score when > 20% gap
3. Ambiguous conflicts (< 20% gap) return resolved: false with choices
4. User priorities from config file override defaults
5. Allowlist patterns work for exact and wildcard matches
6. Missing config file falls back to defaults gracefully
</verification>

<success_criteria>
- Principles scored by confidence * priority weight
- Conflicts resolved to highest-scoring principle
- Ambiguous conflicts escalate to user
- Config file allows customizing priorities
- Allowlist enables pre-approved safe actions
- Module exports all required functions
</success_criteria>

<output>
After completion, create `.planning/phases/05-knowledge-permissions-safety/05-04-SUMMARY.md`
</output>
