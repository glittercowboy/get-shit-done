---
phase: 05-knowledge-permissions-safety
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/knowledge-safety.js
autonomous: true

must_haves:
  truths:
    - "Claude stops and asks before deleting files or data"
    - "Claude stops and asks before external communications"
    - "Claude stops and asks before costly actions"
    - "Previously granted permissions allow autonomous execution"
  artifacts:
    - path: "get-shit-done/bin/knowledge-safety.js"
      provides: "Stop-and-ask safety gates"
      exports: ["executeWithSafetyCheck", "shouldStopAndAsk", "formatApprovalPrompt"]
  key_links:
    - from: "get-shit-done/bin/knowledge-safety.js"
      to: "get-shit-done/bin/knowledge-principles.js"
      via: "classifyAction for action categorization"
      pattern: "classifyAction"
    - from: "get-shit-done/bin/knowledge-safety.js"
      to: "get-shit-done/bin/knowledge-permissions.js"
      via: "checkPermission for grant verification"
      pattern: "checkPermission"
---

<objective>
Create stop-and-ask safety gates for dangerous actions

Purpose: Implement KNOW-20 (irreversible), KNOW-21 (external), KNOW-22 (costly) safety gates. System stops execution and asks user approval before proceeding with dangerous actions unless explicitly permitted.

Output: knowledge-safety.js module with safety check functions and approval prompt formatting
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-knowledge-permissions-safety/05-RESEARCH.md
@get-shit-done/bin/knowledge-principles.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create safety gate module</name>
  <files>get-shit-done/bin/knowledge-safety.js</files>
  <action>
Create knowledge-safety.js with:

1. **shouldStopAndAsk(action, context = {})** - Determine if action requires approval
   - Import classifyAction from knowledge-principles.js
   - Get classification = classifyAction(action)
   - If category is 'irreversible': return { stop: true, reason: 'irreversible_action', category, prompt: formatApprovalPrompt(action, 'irreversible') }
   - If category is 'external': return { stop: true, reason: 'external_communication', category, prompt: formatApprovalPrompt(action, 'external') }
   - If category is 'costly': return { stop: true, reason: 'costly_action', category, prompt: formatApprovalPrompt(action, 'costly') }
   - If category is 'reversible': return { stop: false, reason: 'safe_action', category }

2. **formatApprovalPrompt(action, category)** - Create human-readable prompt
   - irreversible: "This action will {action}. This cannot be undone. Proceed? [y/N]"
   - external: "This will communicate externally: {action}. Proceed? [y/N]"
   - costly: "This action may incur costs: {action}. Proceed? [y/N]"
   - Return string prompt

3. **executeWithSafetyCheck(action, context = {}, options = {})** - Full safety check flow
   - Step 1: Call shouldStopAndAsk(action, context)
   - If stop required:
     - Try to check permission via lazy-loaded checkPermission (wrap in try/catch)
     - If permission check throws (module not ready), treat as no permission
     - If permitted: return { proceed: true, autonomous: true, via: 'permission', grant_id }
     - If not permitted: return { proceed: false, requires_approval: true, reason, prompt, category }
   - If no stop required: return { proceed: true, autonomous: true, reason: 'safe_action' }

4. Export: shouldStopAndAsk, formatApprovalPrompt, executeWithSafetyCheck

Note: Use lazy loading for knowledge-permissions.js to avoid circular dependencies. Wrap require in function call.
  </action>
  <verify>
Run:
```bash
node -e "
const { shouldStopAndAsk, formatApprovalPrompt } = require('./get-shit-done/bin/knowledge-safety.js');
console.log('Delete:', shouldStopAndAsk('delete file important.txt'));
console.log('Send email:', shouldStopAndAsk('send email to client'));
console.log('Cloud:', shouldStopAndAsk('create cloud_resource on AWS'));
console.log('Edit:', shouldStopAndAsk('edit file config.js'));
"
```
Should show: stop: true for delete/email/cloud, stop: false for edit
  </verify>
  <done>Safety gate module with category-based stop-and-ask logic and prompt formatting</done>
</task>

<task type="auto">
  <name>Task 2: Enhance action classification for external communications</name>
  <files>get-shit-done/bin/knowledge-principles.js</files>
  <action>
Update ACTION_TYPES.external in knowledge-principles.js to include more patterns:

```javascript
external: [
  'send_email', 'api_call', 'notification', 'webhook',
  'http_request', 'post_to', 'publish', 'broadcast',
  'slack_message', 'discord_message', 'telegram_send',
  'sms', 'push_notification'
]
```

Also add contextual detection in classifyAction after keyword loop:

```javascript
// External communication detection
if ((lowerAction.includes('send') || lowerAction.includes('post') || lowerAction.includes('publish')) &&
    (lowerAction.includes('email') || lowerAction.includes('message') || lowerAction.includes('notification') ||
     lowerAction.includes('slack') || lowerAction.includes('discord') || lowerAction.includes('telegram'))) {
  return { category: 'external', keyword: 'communication_detected' };
}
```

Add after the existing production/delete detection block.
  </action>
  <verify>
Run:
```bash
node -e "
const { classifyAction } = require('./get-shit-done/bin/knowledge-principles.js');
console.log('send email:', classifyAction('send email to user'));
console.log('post to slack:', classifyAction('post message to slack'));
console.log('publish event:', classifyAction('publish notification'));
console.log('http POST:', classifyAction('http_request to external API'));
"
```
All should return category: 'external'
  </verify>
  <done>Enhanced external communication detection with contextual patterns</done>
</task>

<task type="auto">
  <name>Task 3: Add cost estimation patterns</name>
  <files>get-shit-done/bin/knowledge-safety.js</files>
  <action>
Add cost estimation to knowledge-safety.js:

1. **estimateActionCost(action, context = {})** - Estimate cost of action
   - If action includes 'aws:' or 'cloud_resource': return 0.10 (conservative)
   - If action includes 'api_call' with context.estimated_tokens: return (tokens / 1000000) * 0.50
   - If action includes 'paid_api': return 0.05
   - If action includes 'large_compute': return 1.00
   - Default: return 0.0

2. **Update executeWithSafetyCheck** to include cost estimate in response:
   - If category is 'costly', add estimated_cost field to response
   - Modify prompt to include estimated cost: "This action may cost ~$X.XX: {action}. Proceed?"

3. **Add costly action patterns to knowledge-principles.js ACTION_TYPES.costly:**
```javascript
costly: [
  'cloud_resource', 'paid_api', 'large_compute',
  'aws_', 'gcp_', 'azure_', 'stripe_charge',
  'openai_', 'anthropic_', 'deploy_to'
]
```

Export estimateActionCost from knowledge-safety.js.
  </action>
  <verify>
Run:
```bash
node -e "
const { estimateActionCost, executeWithSafetyCheck } = require('./get-shit-done/bin/knowledge-safety.js');
console.log('AWS cost:', estimateActionCost('aws:s3:upload'));
console.log('API cost:', estimateActionCost('api_call to openai', { estimated_tokens: 1000000 }));
const result = executeWithSafetyCheck('deploy_to production');
console.log('Deploy check:', result.proceed, result.estimated_cost !== undefined);
"
```
Should show AWS cost: 0.1, API cost: 0.5, Deploy check: false true
  </verify>
  <done>Cost estimation for costly actions with enhanced pattern detection</done>
</task>

</tasks>

<verification>
1. shouldStopAndAsk correctly identifies irreversible, external, and costly actions
2. formatApprovalPrompt creates clear human-readable prompts
3. External communication patterns are comprehensive
4. Cost estimation provides reasonable defaults
5. executeWithSafetyCheck integrates classification, permission check, and cost estimation
</verification>

<success_criteria>
- Irreversible actions (delete, drop, truncate) trigger stop-and-ask
- External communications (email, slack, webhooks) trigger stop-and-ask
- Costly actions (AWS, API calls, deploys) trigger stop-and-ask with cost estimate
- Safe/reversible actions proceed without prompt
- Approval prompts are clear and actionable
</success_criteria>

<output>
After completion, create `.planning/phases/05-knowledge-permissions-safety/05-02-SUMMARY.md`
</output>
