---
phase: 05-knowledge-permissions-safety
plan: 03
type: execute
wave: 2
depends_on: ["05-01"]
files_modified:
  - get-shit-done/bin/knowledge-db.js
  - get-shit-done/bin/knowledge-cost.js
autonomous: true

must_haves:
  truths:
    - "System tracks costs of actions with timestamps"
    - "Budget alerts fire at 50%, 80%, 90%, 100% thresholds"
    - "Each threshold alert fires only once per budget period"
    - "Circuit breaker activates at 100% budget"
  artifacts:
    - path: "get-shit-done/bin/knowledge-cost.js"
      provides: "Cost tracking and budget alerts"
      exports: ["trackCost", "checkBudgetAlerts", "getTotalCost", "enableCircuitBreaker", "isCircuitBreakerEnabled"]
    - path: "get-shit-done/bin/knowledge-db.js"
      provides: "cost_tracking and budget_alerts tables"
      contains: "CREATE TABLE IF NOT EXISTS cost_tracking"
  key_links:
    - from: "get-shit-done/bin/knowledge-cost.js"
      to: "get-shit-done/bin/knowledge-db.js"
      via: "openKnowledgeDB for database access"
      pattern: "openKnowledgeDB"
---

<objective>
Create cost tracking and graduated budget alerts

Purpose: Implement graduated budget monitoring (KNOW-22 enhancement, OBSV-03 from Phase 8 can reuse). Track action costs, alert at configurable thresholds (50%/80%/90%/100%), and enable circuit breaker when budget exhausted.

Output: knowledge-cost.js module with cost tracking and budget alert functions, schema extension for cost tables
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/05-knowledge-permissions-safety/05-RESEARCH.md
@get-shit-done/bin/knowledge-db.js
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add cost tracking schema</name>
  <files>get-shit-done/bin/knowledge-db.js</files>
  <action>
Add cost_tracking and budget_alerts tables to createSchema():

```sql
-- Cost tracking table
CREATE TABLE IF NOT EXISTS cost_tracking (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  action TEXT NOT NULL,
  cost REAL NOT NULL,
  timestamp INTEGER NOT NULL,
  metadata TEXT
);

CREATE INDEX IF NOT EXISTS idx_cost_timestamp ON cost_tracking(timestamp DESC);

-- Budget alerts tracking (deduplication)
CREATE TABLE IF NOT EXISTS budget_alerts (
  id INTEGER PRIMARY KEY AUTOINCREMENT,
  threshold REAL NOT NULL,
  period_start INTEGER NOT NULL,
  fired_at INTEGER NOT NULL,
  UNIQUE(threshold, period_start)
);

-- Circuit breaker state
CREATE TABLE IF NOT EXISTS circuit_breaker (
  id INTEGER PRIMARY KEY CHECK (id = 1),
  enabled INTEGER NOT NULL DEFAULT 0,
  reason TEXT,
  enabled_at INTEGER
);

INSERT OR IGNORE INTO circuit_breaker (id, enabled) VALUES (1, 0);
```

Update SCHEMA_VERSION to 3 with migration from v2.
  </action>
  <verify>
Run:
```bash
node -e "
const { openKnowledgeDB } = require('./get-shit-done/bin/knowledge-db.js');
const conn = openKnowledgeDB('project');
const tables = conn.db.prepare('SELECT name FROM sqlite_master WHERE type=\\'table\\' ORDER BY name').all();
console.log('Tables:', tables.map(t => t.name).join(', '));
"
```
Should include: budget_alerts, circuit_breaker, cost_tracking
  </verify>
  <done>Cost tracking, budget alerts, and circuit breaker tables added with schema v3</done>
</task>

<task type="auto">
  <name>Task 2: Create cost tracking module</name>
  <files>get-shit-done/bin/knowledge-cost.js</files>
  <action>
Create knowledge-cost.js with:

1. **Constants:**
```javascript
const ALERT_THRESHOLDS = [0.5, 0.8, 0.9, 1.0];
const DEFAULT_BUDGET = { daily: 5.0, weekly: 25.0 };
```

2. **trackCost(db, { action, cost, metadata = {} })** - Record cost
   - INSERT INTO cost_tracking (action, cost, timestamp, metadata)
   - Call checkBudgetAlerts(db, cost) to check thresholds
   - Return { tracked: true, cost, total_cost, alerts }

3. **getTotalCost(db, period = 'daily')** - Get spending for period
   - Calculate periodStart via getStartOfPeriod(period)
   - SELECT SUM(cost) FROM cost_tracking WHERE timestamp >= periodStart
   - Return total cost as number

4. **getStartOfPeriod(period)** - Calculate period start timestamp
   - 'daily': Start of current day (setHours(0,0,0,0))
   - 'weekly': Start of current week (day 0 = Sunday)
   - Return timestamp in milliseconds

5. **getBudgetLimit(period)** - Get budget for period
   - Try to load from config file (.planning/knowledge/permissions-config.json)
   - Fall back to DEFAULT_BUDGET
   - Return number

6. **checkBudgetAlerts(db, newCost = 0)** - Check and fire alerts
   - totalCost = getTotalCost(db) + newCost
   - budget = getBudgetLimit('daily')
   - percentage = totalCost / budget
   - For each threshold in ALERT_THRESHOLDS:
     - If percentage >= threshold AND not already fired (check budget_alerts table):
       - Add to alerts array with level (critical/high/warning)
       - markAlertFired(db, threshold, periodStart)
       - If threshold === 1.0: enableCircuitBreaker(db, 'budget_exceeded')
   - Return { total_cost, budget, percentage, alerts }

7. **hasAlertFired(db, threshold, periodStart)** - Check if alert already sent
   - SELECT FROM budget_alerts WHERE threshold = ? AND period_start = ?
   - Return boolean

8. **markAlertFired(db, threshold, periodStart)** - Record alert
   - INSERT INTO budget_alerts (threshold, period_start, fired_at)

Export all functions.
  </action>
  <verify>
Run:
```bash
node -e "
const { openKnowledgeDB } = require('./get-shit-done/bin/knowledge-db.js');
const { trackCost, getTotalCost, checkBudgetAlerts } = require('./get-shit-done/bin/knowledge-cost.js');
const conn = openKnowledgeDB('project');
const result = trackCost(conn.db, { action: 'api_call', cost: 0.50 });
console.log('Tracked:', result.tracked, 'Total:', result.total_cost);
const total = getTotalCost(conn.db, 'daily');
console.log('Daily total:', total);
"
```
Should show tracking works and total accumulates
  </verify>
  <done>Cost tracking module with period-based totals and budget checks</done>
</task>

<task type="auto">
  <name>Task 3: Implement circuit breaker</name>
  <files>get-shit-done/bin/knowledge-cost.js</files>
  <action>
Add circuit breaker functions to knowledge-cost.js:

1. **enableCircuitBreaker(db, reason)** - Activate circuit breaker
   - UPDATE circuit_breaker SET enabled = 1, reason = ?, enabled_at = ? WHERE id = 1
   - Return { enabled: true, reason, enabled_at }

2. **disableCircuitBreaker(db)** - Deactivate circuit breaker
   - UPDATE circuit_breaker SET enabled = 0, reason = NULL, enabled_at = NULL WHERE id = 1
   - Return { enabled: false }

3. **isCircuitBreakerEnabled(db)** - Check circuit breaker state
   - SELECT enabled, reason, enabled_at FROM circuit_breaker WHERE id = 1
   - Return { enabled: boolean, reason?: string, enabled_at?: number }

4. **shouldBlockCostlyAction(db)** - Check if costly actions should be blocked
   - If isCircuitBreakerEnabled(db).enabled: return { blocked: true, reason }
   - Else: return { blocked: false }

5. **Update checkBudgetAlerts** to include circuit breaker info in response
   - Add circuit_breaker_enabled: boolean to return object

6. **getAlertLevel(threshold)** - Map threshold to severity
   - 1.0 → 'critical'
   - 0.9 → 'high'
   - 0.8 → 'warning'
   - 0.5 → 'info'

Export: enableCircuitBreaker, disableCircuitBreaker, isCircuitBreakerEnabled, shouldBlockCostlyAction
  </action>
  <verify>
Run:
```bash
node -e "
const { openKnowledgeDB } = require('./get-shit-done/bin/knowledge-db.js');
const { enableCircuitBreaker, isCircuitBreakerEnabled, disableCircuitBreaker, shouldBlockCostlyAction } = require('./get-shit-done/bin/knowledge-cost.js');
const conn = openKnowledgeDB('project');
enableCircuitBreaker(conn.db, 'budget_exceeded');
const state = isCircuitBreakerEnabled(conn.db);
console.log('Enabled:', state.enabled, 'Reason:', state.reason);
const block = shouldBlockCostlyAction(conn.db);
console.log('Should block:', block.blocked);
disableCircuitBreaker(conn.db);
console.log('After disable:', isCircuitBreakerEnabled(conn.db).enabled);
"
```
Should show enabled/blocked true, then false after disable
  </verify>
  <done>Circuit breaker with enable/disable/check functions and costly action blocking</done>
</task>

</tasks>

<verification>
1. Cost tracking persists to database with timestamps
2. Period totals (daily/weekly) calculate correctly
3. Budget alerts fire at correct thresholds (50%, 80%, 90%, 100%)
4. Each alert fires only once per period (deduplication works)
5. Circuit breaker activates at 100% budget
6. Circuit breaker can be manually enabled/disabled
7. shouldBlockCostlyAction respects circuit breaker state
</verification>

<success_criteria>
- Costs tracked with action, amount, timestamp
- Daily and weekly totals available
- Graduated alerts at configurable thresholds
- Alert deduplication prevents spam
- Circuit breaker auto-activates at 100% budget
- Circuit breaker blocks costly actions when enabled
</success_criteria>

<output>
After completion, create `.planning/phases/05-knowledge-permissions-safety/05-03-SUMMARY.md`
</output>
