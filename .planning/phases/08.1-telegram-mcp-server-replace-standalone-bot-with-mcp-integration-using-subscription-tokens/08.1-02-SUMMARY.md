---
phase: 08.1-telegram-mcp-server
plan: 02
subsystem: persistence
tags: [mcp, telegram, jsonl, storage, durability]
dependency_graph:
  requires: []
  provides:
    - question-queue-storage
    - message-queue-storage
    - jsonl-persistence-layer
  affects:
    - 08.1-03 (MCP tools will use question queue)
    - 08.1-04 (MCP resources will use message queue)
tech_stack:
  added:
    - TypeScript file-based storage modules
    - JSONL persistence format
    - Atomic write pattern (temp + rename)
  patterns:
    - Append-only JSONL for new entries
    - Atomic rewrite for updates
    - Auto-create directories on first use
    - Graceful handling of malformed JSON
key_files:
  created:
    - mcp-servers/telegram-mcp/src/storage/question-queue.ts
    - mcp-servers/telegram-mcp/src/storage/message-queue.ts
    - mcp-servers/telegram-mcp/src/storage/index.ts
    - .planning/telegram-questions/pending.jsonl
    - .planning/telegram-queue/requirements.jsonl
  modified: []
decisions:
  - Use PROJECT_ROOT resolution (env var or path traversal) instead of process.cwd() for MCP server portability
  - UUID for question IDs, ISO timestamp for requirement IDs
  - Archive answered questions to daily session logs (.planning/telegram-sessions/YYYY-MM-DD.jsonl)
  - Filter malformed JSON lines instead of failing (resilience over strictness)
metrics:
  duration: 4
  completed: 2026-02-17T10:27:05Z
  tasks: 3
  commits: 3
---

# Phase 08.1 Plan 02: JSONL-Based Persistence Layer Summary

JSONL-based storage modules for question queues and requirements, enabling state to survive MCP server restarts without database dependencies.

## What Was Built

Created two TypeScript storage modules with CRUD operations and atomic write guarantees:

**Question Queue (`question-queue.ts`):**
- PendingQuestion interface with UUID, status tracking, timestamps
- `appendQuestion()` - Generate UUID, append to JSONL
- `loadPendingQuestions()` - Read and parse pending.jsonl, filter by status
- `markAnswered()` - Update status, atomic rewrite, archive to daily log
- `archiveQuestion()` - Append to `.planning/telegram-sessions/YYYY-MM-DD.jsonl`
- `getPendingById()` - Find single question by ID

**Message Queue (`message-queue.ts`):**
- RequirementMessage interface with timestamp, processed flag
- `appendRequirement()` - Append message to requirements.jsonl
- `loadRequirements()` - Read and parse all messages
- `loadUnprocessedRequirements()` - Filter to processed=false
- `markProcessed()` - Atomic update of processed flag
- `clearRequirements()` - Truncate file (cleanup)
- `getRequirementsAsNDJSON()` - Raw JSONL content for MCP resource

**Storage Index (`index.ts`):**
- Re-exports both modules for convenient imports
- Single import point: `import * from './storage'`

## Implementation Details

**Atomic Write Pattern:**
```typescript
async function writeAtomic(filePath: string, content: string) {
  const tempPath = `${filePath}.tmp`;
  await fs.writeFile(tempPath, content, 'utf8');
  await fs.rename(tempPath, filePath);
}
```

**Project Root Resolution:**
```typescript
function getProjectRoot(): string {
  if (process.env.PROJECT_ROOT) return process.env.PROJECT_ROOT;
  const currentDir = process.cwd();
  if (currentDir.includes('mcp-servers/telegram-mcp')) {
    return path.resolve(currentDir, '../..');
  }
  return currentDir;
}
```

**Error Handling:**
- Malformed JSON lines logged and skipped (don't block reads)
- Empty files return empty arrays (not errors)
- Directories auto-created on first write
- "Not found" errors for mark operations (explicit failure)

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Fixed incorrect path resolution for JSONL files**
- **Found during:** Task 3 verification
- **Issue:** Used `process.cwd()` which points to `mcp-servers/telegram-mcp` when MCP server runs. JSONL files would be created in wrong location, not accessible from project root.
- **Fix:** Added `getProjectRoot()` helper that supports `PROJECT_ROOT` env var or auto-detects via path traversal (resolve from `mcp-servers/telegram-mcp` up to project root)
- **Files modified:**
  - `mcp-servers/telegram-mcp/src/storage/question-queue.ts`
  - `mcp-servers/telegram-mcp/src/storage/message-queue.ts`
- **Commit:** fd7740d
- **Impact:** JSONL files now correctly created at `.planning/telegram-questions/` and `.planning/telegram-queue/` relative to project root, accessible from orchestrators and MCP server

## Verification Results

All verification criteria passed:

- [x] question-queue.ts exports appendQuestion, loadPendingQuestions, markAnswered, archiveQuestion, getPendingById
- [x] message-queue.ts exports appendRequirement, loadRequirements, loadUnprocessedRequirements, markProcessed, clearRequirements, getRequirementsAsNDJSON
- [x] .planning/telegram-questions/ directory created on first write
- [x] .planning/telegram-queue/ directory created on first write
- [x] Questions persist across process restarts (verified with 2 separate node processes)
- [x] Atomic writes prevent file corruption (temp file + rename pattern)
- [x] Malformed JSON lines skipped gracefully
- [x] Empty files handled correctly (return empty arrays)

**Test Results:**
```
Testing question queue...
Created question: e4123f18-822f-41a5-978f-17fe6329d1ef
Loaded: 1 questions
After mark answered: 0 pending questions
✓ Task 1 verification passed

Testing message queue...
Requirements: 2
Unprocessed: 2
NDJSON length: 194
After marking first processed: 1 unprocessed
✓ Task 2 verification passed

Persisted: true
✓ Answered question correctly removed from pending
✓ All edge cases passed
```

## Task Commits

| Task | Name                                    | Commit  | Files                                |
| ---- | --------------------------------------- | ------- | ------------------------------------ |
| 1    | Create question queue storage module    | 25cc788 | question-queue.ts                    |
| 2    | Create message queue storage module     | c2bb797 | message-queue.ts                     |
| 3    | Add storage exports and verify persist  | fd7740d | index.ts, path resolution fixes      |

## Success Criteria Met

**Persistence layer is complete:**
- Questions and requirements survive MCP server restarts
- Atomic writes prevent file corruption
- JSONL format enables easy append and streaming reads
- Ready for MCP tool implementation in Plan 03 (ask_blocking_question)
- Ready for MCP resource implementation in Plan 04 (new_requirements)

## Next Steps

**Plan 08.1-03:** Implement MCP tools using question queue storage
- `ask_blocking_question` tool sends to Telegram, persists to pending.jsonl
- `check_question_answers` tool polls for answers, marks as answered
- Question lifecycle: pending → answered → archived to daily log

**Plan 08.1-04:** Implement MCP resources using message queue storage
- `telegram://requirements/new` resource exposes requirements.jsonl
- Subscription notifications on new requirements
- Orchestrator reads via resource, marks processed

## Self-Check: PASSED

**Created files exist:**
```bash
✓ mcp-servers/telegram-mcp/src/storage/question-queue.ts
✓ mcp-servers/telegram-mcp/src/storage/message-queue.ts
✓ mcp-servers/telegram-mcp/src/storage/index.ts
✓ .planning/telegram-questions/pending.jsonl
✓ .planning/telegram-queue/requirements.jsonl
```

**Commits exist:**
```bash
✓ 25cc788 - Task 1 (question queue)
✓ c2bb797 - Task 2 (message queue)
✓ fd7740d - Task 3 (exports + path fix)
```

**Exports verified:**
```bash
✓ All question-queue functions exported
✓ All message-queue functions exported
✓ Storage index re-exports both modules
```

**JSONL files functional:**
```bash
✓ Questions persist across restarts
✓ Answered questions archived to daily logs
✓ Requirements stored with processed flags
✓ NDJSON format ready for MCP resource
```
