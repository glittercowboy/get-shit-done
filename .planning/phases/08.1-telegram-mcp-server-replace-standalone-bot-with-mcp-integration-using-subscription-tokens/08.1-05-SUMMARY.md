---
phase: 08.1-telegram-mcp-server
plan: 05
subsystem: mcp-integration
tags: [mcp, telegram-bot, resources, lifecycle, integration]
dependency_graph:
  requires: ["08.1-03-storage", "08.1-04-bot"]
  provides: ["integrated-mcp-server", "bot-lifecycle", "requirements-resource"]
  affects: ["mcp-server-startup", "ask-blocking-question-tool"]
tech_stack:
  added: ["dotenv-config-at-server-startup"]
  patterns: ["lazy-bot-initialization", "resource-handlers", "graceful-shutdown"]
key_files:
  created:
    - "mcp-servers/telegram-mcp/src/resources/requirements.ts"
    - "mcp-servers/telegram-mcp/src/resources/index.ts"
  modified:
    - "mcp-servers/telegram-mcp/src/index.ts"
    - "mcp-servers/telegram-mcp/src/tools/ask-question.ts"
    - "mcp-servers/telegram-mcp/src/bot/telegram-bot.ts"
decisions:
  - "Lazy bot initialization to allow MCP server startup without TELEGRAM_BOT_TOKEN"
  - "Graceful error handling in ask_blocking_question (log but don't fail if Telegram send fails)"
  - "Use REQUIREMENTS_RESOURCE_DEF from resources module instead of inline definition"
metrics:
  duration: "4m 35s"
  tasks_completed: 3
  files_created: 2
  files_modified: 3
  commits: 3
  deviations: 1
  completed_at: "2026-02-17T10:48:17Z"
---

# Phase 08.1 Plan 05: MCP Server Integration Summary

**One-liner:** Integrated Telegram bot lifecycle into MCP server with requirements resource handler and lazy initialization pattern.

## What Was Built

Completed full integration of Telegram bot into MCP server lifecycle:

1. **Requirements Resource Handler** (`mcp-servers/telegram-mcp/src/resources/requirements.ts`)
   - Exports `REQUIREMENTS_RESOURCE_DEF` with `telegram://requirements/new` URI
   - Implements `readRequirementsResource()` returning JSONL content from message queue
   - Creates `resources/index.ts` for centralized exports

2. **Telegram Integration in ask_blocking_question Tool**
   - Added `sendMessage` import from bot module
   - Created `formatQuestionMessage()` helper for consistent formatting
   - Sends Telegram message after creating question in queue
   - Graceful error handling (logs but doesn't fail if send fails)
   - Skips Telegram send if `TELEGRAM_OWNER_ID` not set

3. **Bot Lifecycle Wired into MCP Server**
   - Loads `dotenv/config` at server startup
   - Imports `startBot`, `stopBot` from bot module
   - Imports resource handlers from resources module
   - Starts bot after MCP server connects to transport
   - Handles graceful shutdown (stops bot before exit)
   - Wires real resource handlers into `resources/list` and `resources/read`

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 3 - Blocking Fix] Made bot initialization lazy**
- **Found during:** Task 3 - MCP server startup testing
- **Issue:** Bot module threw error at import time if `TELEGRAM_BOT_TOKEN` not set, preventing MCP server from starting
- **Root cause:** Bot instance was created at module load time with hard-coded token check
- **Fix applied:**
  - Made bot instance lazy-initialized (created only when `startBot()` is called)
  - Created `initializeBot()` function to create bot with all handlers
  - Moved all handler registrations into `setupHandlers()` function
  - Added null checks in `sendMessage()`, `sendBlockingQuestion()`, `stopBot()`, `getBot()`
  - Changed `getBot()` return type to `Telegraf<BotContext> | null`
- **Files modified:**
  - `mcp-servers/telegram-mcp/src/bot/telegram-bot.ts`
- **Commit:** 323a540 (included in Task 3 commit)
- **Rationale:** This fix allows MCP server to start without TELEGRAM_BOT_TOKEN set, making it possible to test the server independently and gracefully degrade when bot credentials are missing.

## Task Breakdown

| Task | Description | Commit | Files |
|------|-------------|--------|-------|
| 1 | Create requirements resource handler | 0fecf80 | `resources/requirements.ts`, `resources/index.ts` |
| 2 | Update ask_blocking_question to send Telegram message | 4b5ed26 | `tools/ask-question.ts` |
| 3 | Wire bot lifecycle and resources into MCP server | 323a540 | `index.ts`, `bot/telegram-bot.ts` |

## Verification Results

- ✅ MCP server starts without TELEGRAM_BOT_TOKEN (graceful degradation)
- ✅ MCP server starts Telegram bot when TELEGRAM_BOT_TOKEN is set
- ✅ ask_blocking_question sends message to Telegram chat (when bot running)
- ✅ resources/list returns telegram://requirements/new
- ✅ resources/read returns JSONL content from queue
- ✅ Graceful shutdown stops bot before exit
- ✅ All logging goes to stderr (stdout reserved for JSON-RPC)
- ✅ JSON-RPC protocol handling works (3 responses to 3 requests)

## Integration Points

**Upstream dependencies:**
- 08.1-03: Storage modules (question-queue, message-queue)
- 08.1-04: Telegram bot implementation

**Downstream impact:**
- 08.1-06: Claude Code configuration can now use MCP server with all features integrated

**Key interfaces:**
- MCP server exposes `telegram://requirements/new` resource
- Tools use `sendMessage()` to send Telegram notifications
- Bot lifecycle managed by MCP server (start on init, stop on shutdown)

## Technical Notes

**Lazy initialization pattern:**
```typescript
let bot: Telegraf<BotContext> | null = null;

function initializeBot(): Telegraf<BotContext> {
  const botInstance = new Telegraf(process.env.TELEGRAM_BOT_TOKEN);
  botInstance.use(session({...}));
  setupHandlers(botInstance);
  return botInstance;
}

export async function startBot(): Promise<void> {
  if (!bot) {
    bot = initializeBot();
  }
  await bot.launch();
}
```

**Error handling strategy:**
- Bot import-time errors → prevented via lazy init
- Telegram send failures → logged but don't fail tool execution
- Missing TELEGRAM_BOT_TOKEN → server runs without bot (questions queue only)
- Missing TELEGRAM_OWNER_ID → send skipped, warning logged

**Resource handler pattern:**
```typescript
export const REQUIREMENTS_RESOURCE_DEF = {
  uri: 'telegram://requirements/new',
  name: 'New Requirements from Telegram',
  description: 'JSONL stream of new requirement messages from user',
  mimeType: 'application/x-ndjson'
};

export async function readRequirementsResource(uri: string) {
  if (uri !== 'telegram://requirements/new') {
    throw new Error(`Unknown resource: ${uri}`);
  }
  const content = await getRequirementsAsNDJSON();
  return { contents: [{ uri, mimeType: 'application/x-ndjson', text: content }] };
}
```

## Next Steps

Plan 08.1-06 will configure Claude Code to use this MCP server, enabling:
- Autonomous agents to ask blocking questions via Telegram
- Requirements resource subscription for new user inputs
- Full orchestrator integration with Telegram notification channel

## Self-Check: PASSED

**Created files verification:**
```
✅ FOUND: mcp-servers/telegram-mcp/src/resources/requirements.ts
✅ FOUND: mcp-servers/telegram-mcp/src/resources/index.ts
```

**Modified files verification:**
```
✅ FOUND: mcp-servers/telegram-mcp/src/index.ts
✅ FOUND: mcp-servers/telegram-mcp/src/tools/ask-question.ts
✅ FOUND: mcp-servers/telegram-mcp/src/bot/telegram-bot.ts
```

**Commits verification:**
```
✅ FOUND: 0fecf80 (Task 1)
✅ FOUND: 4b5ed26 (Task 2)
✅ FOUND: 323a540 (Task 3)
```

All files created, modified, and commits verified successfully.
