---
phase: 06-autonomous-execution-core
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - get-shit-done/bin/knowledge-checkpoint.js
  - get-shit-done/bin/gsd-tools.js
autonomous: true

must_haves:
  truths:
    - "Checkpoints store structured state after each significant action"
    - "Checkpoints are searchable via semantic search"
    - "Resume queries find relevant checkpoints for continuation"
    - "Checkpoint format matches EXEC-09 specification"
  artifacts:
    - path: "get-shit-done/bin/knowledge-checkpoint.js"
      provides: "Checkpoint storage and retrieval via knowledge system"
      exports: ["createCheckpoint", "searchCheckpoints", "getCheckpointById", "cleanupCheckpoints"]
      min_lines: 100
  key_links:
    - from: "get-shit-done/bin/knowledge-checkpoint.js"
      to: "get-shit-done/bin/knowledge.js"
      via: "knowledge system integration"
      pattern: "require\\('./knowledge"
    - from: "knowledge-checkpoint.js"
      to: "knowledge-crud.js"
      via: "CRUD operations"
      pattern: "insertKnowledge|searchKnowledge"
---

<objective>
Create checkpoint storage and retrieval system using Phase 3 knowledge infrastructure.

Purpose: Enable structured checkpoints with semantic search for resume capability (EXEC-09, EXEC-10).
Output: knowledge-checkpoint.js module integrated with knowledge system, CLI commands for checkpoint operations.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autonomous-execution-core/06-RESEARCH.md
@.planning/phases/03-knowledge-system-foundation/03-02-SUMMARY.md
@.planning/phases/03-knowledge-system-foundation/03-03-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create knowledge-checkpoint module</name>
  <files>get-shit-done/bin/knowledge-checkpoint.js</files>
  <action>
Create knowledge-checkpoint.js that stores checkpoints as knowledge entries:

**Checkpoint schema (EXEC-09):**
```javascript
const CHECKPOINT_SCHEMA = {
  task_title: 'string',         // Human-readable task name
  plan: 'array',                // Planned steps for this task
  progress: {
    completed: 'array',         // Completed steps with timestamps
    current: 'string',          // Current step in execution
    remaining: 'array'          // Remaining steps
  },
  files_touched: 'array',       // Files created/modified
  decisions: 'array',           // Key decisions made
  key_context: 'string',        // Semantic context for resume (200-500 chars)
  next_steps: 'array',          // What to do when resuming
  created_at: 'timestamp',      // ISO 8601
  phase: 'number',              // Phase number
  plan_id: 'string'             // Plan ID (e.g., "03-01")
};
```

**Functions:**

1. **createCheckpoint(checkpoint)** - Store checkpoint in knowledge system:
   - Validate required fields: task_title, plan, progress, phase
   - Generate semantic context for search:
     ```
     Phase {phase}: {task_title}
     Current: {progress.current}
     Progress: {completed.length}/{plan.length}
     Context: {key_context}
     Next: {next_steps.join(', ')}
     ```
   - Lazy-load knowledge module: `const knowledge = require('./knowledge.js')`
   - Get connection: `const conn = knowledge._getConnection('project')`
   - Generate embedding for semantic context using embeddings.js
   - Insert as knowledge entry:
     ```javascript
     await knowledge.insertKnowledge(conn, {
       content: JSON.stringify(checkpoint),
       type: 'checkpoint',
       scope: 'project',
       embedding: embedding,
       ttl_category: 'ephemeral',  // 24h TTL
       metadata: JSON.stringify({
         phase: checkpoint.phase,
         plan_id: checkpoint.plan_id,
         task_title: checkpoint.task_title,
         semantic_context: semanticContext
       })
     });
     ```
   - Return: { checkpoint_id, created_at }

2. **searchCheckpoints(query, options)** - Semantic search for checkpoints:
   - Options: { phase?, limit?, include_complete? }
   - Generate embedding for query
   - Search with type filter: 'checkpoint'
   - Parse content JSON for each result
   - Return: Checkpoint[]

3. **getCheckpointById(id)** - Get specific checkpoint:
   - Query by knowledge ID
   - Parse and return checkpoint data

4. **getLatestCheckpoint(phase, planId?)** - Get most recent checkpoint:
   - Search checkpoints filtered by phase (and optionally planId)
   - Sort by created_at descending
   - Return first result

5. **cleanupCheckpoints(options)** - Remove old checkpoints:
   - Options: { phase?, older_than?, completed_only? }
   - Delete matching checkpoints
   - Return: { deleted_count }

Module exports: { CHECKPOINT_SCHEMA, createCheckpoint, searchCheckpoints, getCheckpointById, getLatestCheckpoint, cleanupCheckpoints }
  </action>
  <verify>
```bash
# Verify module exists and exports
node -e "const c = require('./get-shit-done/bin/knowledge-checkpoint.js'); console.log(Object.keys(c))"
# Should include: CHECKPOINT_SCHEMA, createCheckpoint, searchCheckpoints, getCheckpointById, getLatestCheckpoint, cleanupCheckpoints
```
  </verify>
  <done>knowledge-checkpoint.js exists with CHECKPOINT_SCHEMA and CRUD functions for checkpoint storage</done>
</task>

<task type="auto">
  <name>Task 2: Integrate checkpoint commands into gsd-tools</name>
  <files>get-shit-done/bin/gsd-tools.js</files>
  <action>
Add checkpoint subcommands to gsd-tools.js:

1. **checkpoint create** - Create checkpoint from args:
   ```bash
   node gsd-tools.js checkpoint create \
     --phase 3 \
     --plan-id "03-01" \
     --task "Database Setup" \
     --plan "step1,step2,step3" \
     --completed "step1" \
     --current "step2" \
     --key-context "Setting up SQLite with WAL mode" \
     --files "knowledge-db.js,schema.sql" \
     --decisions "Use WAL mode,Use AUTOINCREMENT" \
     --next-steps "Add FTS5,Test queries"
   ```
   Build checkpoint object from args, call createCheckpoint

2. **checkpoint search** - Search checkpoints:
   ```bash
   node gsd-tools.js checkpoint search --query "incomplete phase 3" --limit 5
   node gsd-tools.js checkpoint search --phase 3
   ```
   Return matching checkpoints as JSON

3. **checkpoint latest** - Get latest checkpoint:
   ```bash
   node gsd-tools.js checkpoint latest --phase 3
   node gsd-tools.js checkpoint latest --phase 3 --plan-id "03-02"
   ```

4. **checkpoint cleanup** - Clean up checkpoints:
   ```bash
   node gsd-tools.js checkpoint cleanup --phase 3
   node gsd-tools.js checkpoint cleanup --all
   node gsd-tools.js checkpoint cleanup --older-than 24h
   ```

Add require statement (lazy-loaded in command handler):
```javascript
// Inside checkpoint case handler:
const checkpoint = require('./knowledge-checkpoint.js');
```

Add case handler for 'checkpoint' command.
  </action>
  <verify>
```bash
# Test checkpoint create
node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js checkpoint create \
  --phase 6 \
  --plan-id "06-04" \
  --task "Test Checkpoint" \
  --plan "step1,step2" \
  --completed "" \
  --current "step1" \
  --key-context "Testing checkpoint system" \
  --files "" \
  --decisions "" \
  --next-steps "Complete step1"

# Test checkpoint search
node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js checkpoint search --phase 6

# Test checkpoint latest
node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js checkpoint latest --phase 6
```
  </verify>
  <done>gsd-tools.js responds to "checkpoint create", "checkpoint search", "checkpoint latest", "checkpoint cleanup" commands</done>
</task>

<task type="auto">
  <name>Task 3: Add resume-from-checkpoint function</name>
  <files>get-shit-done/bin/knowledge-checkpoint.js</files>
  <action>
Add resume capability to knowledge-checkpoint.js:

1. **findResumePoint(phase, query?)** - Find checkpoint to resume from:
   - Default query: "incomplete {phase} tasks"
   - Search checkpoints for phase
   - Find most recent with non-empty progress.remaining
   - Return: { found: boolean, checkpoint?, resume_context? }

   Resume context structure:
   ```javascript
   {
     task: checkpoint.task_title,
     current_step: checkpoint.progress.current,
     completed_steps: checkpoint.progress.completed,
     remaining_steps: checkpoint.progress.remaining,
     next_steps: checkpoint.next_steps,
     files_touched: checkpoint.files_touched,
     decisions: checkpoint.decisions,
     key_context: checkpoint.key_context
   }
   ```

2. **buildResumePrompt(checkpoint)** - Generate prompt for resumed execution:
   - Format checkpoint data into structured prompt
   - Include completed work (don't repeat)
   - Include context for continuation
   - Return: string (prompt content)

3. **markCheckpointComplete(checkpointId)** - Mark checkpoint as completed:
   - Update checkpoint progress.remaining to []
   - Update progress.current to "completed"
   - Return: { success: boolean }

4. **getCheckpointHistory(phase)** - Get all checkpoints for phase timeline:
   - Search all checkpoints for phase
   - Sort by created_at ascending
   - Return: Checkpoint[] (chronological)

Update module exports.
  </action>
  <verify>
```bash
# Verify new exports
node -e "const c = require('./get-shit-done/bin/knowledge-checkpoint.js'); console.log(Object.keys(c))"
# Should include: findResumePoint, buildResumePrompt, markCheckpointComplete, getCheckpointHistory

# Test findResumePoint
node -e "const c = require('./get-shit-done/bin/knowledge-checkpoint.js'); c.findResumePoint(6).then(r => console.log(r))"
```
  </verify>
  <done>knowledge-checkpoint.js includes findResumePoint, buildResumePrompt, markCheckpointComplete, getCheckpointHistory functions</done>
</task>

</tasks>

<verification>
- knowledge-checkpoint.js exists in get-shit-done/bin/
- All functions exported: CHECKPOINT_SCHEMA, createCheckpoint, searchCheckpoints, getCheckpointById, getLatestCheckpoint, cleanupCheckpoints, findResumePoint, buildResumePrompt, markCheckpointComplete, getCheckpointHistory
- gsd-tools.js responds to "checkpoint" command with subcommands
- Checkpoints stored as knowledge entries with type: 'checkpoint'
- Semantic search returns relevant checkpoints for resume queries
- Checkpoint format matches EXEC-09 specification
</verification>

<success_criteria>
- Checkpoint creation stores structured state in knowledge DB
- Semantic search finds relevant checkpoints for resume
- Resume context provides enough info to continue execution
- CLI commands work for all checkpoint operations
- Integration with existing knowledge system (Phase 3)
</success_criteria>

<output>
After completion, create `.planning/phases/06-autonomous-execution-core/06-04-SUMMARY.md`
</output>
