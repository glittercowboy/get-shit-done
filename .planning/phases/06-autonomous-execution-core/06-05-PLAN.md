---
phase: 06-autonomous-execution-core
plan: 05
type: execute
wave: 3
depends_on: ["06-02", "06-03", "06-04"]
files_modified:
  - get-shit-done/bin/phase-archive.js
  - get-shit-done/bin/gsd-tools.js
  - get-shit-done/workflows/execute-roadmap.md
autonomous: false

must_haves:
  truths:
    - "Completed phases are archived with compressed context"
    - "Context cleanup prevents rot across long execution"
    - "Only relevant history injected into next phase"
    - "Full end-to-end roadmap execution works"
  artifacts:
    - path: "get-shit-done/bin/phase-archive.js"
      provides: "Phase context archiving and compression"
      exports: ["archivePhase", "compressContext", "injectRelevantContext"]
      min_lines: 80
  key_links:
    - from: "execute-roadmap.md"
      to: "phase-archive.js"
      via: "gsd-tools phase archive command"
      pattern: "phase archive"
    - from: "phase-archive.js"
      to: ".planning/phases/"
      via: "ARCHIVE.json creation"
      pattern: "ARCHIVE.json"
---

<objective>
Create phase archiving and context management for multi-phase execution.

Purpose: Prevent context rot by archiving completed phases and selectively injecting relevant history (EXEC-07).
Output: phase-archive.js module with archiving functions, integration into execute-roadmap workflow.
</objective>

<execution_context>
@/Users/ollorin/.claude/get-shit-done/workflows/execute-plan.md
@/Users/ollorin/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-autonomous-execution-core/06-RESEARCH.md
@.planning/phases/06-autonomous-execution-core/06-02-SUMMARY.md
@.planning/phases/06-autonomous-execution-core/06-03-SUMMARY.md
@.planning/phases/06-autonomous-execution-core/06-04-SUMMARY.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create phase-archive module</name>
  <files>get-shit-done/bin/phase-archive.js</files>
  <action>
Create phase-archive.js for context archiving and compression:

**Functions:**

1. **archivePhase(phaseNumber)** - Create ARCHIVE.json for completed phase:
   - Read all SUMMARY.md files in phase directory
   - Extract key information: objectives, decisions, tech stack, files created
   - Get verification status from VERIFICATION.md
   - Create archive structure:
     ```javascript
     {
       phase: number,
       name: string,
       completed_at: ISO timestamp,
       summary: {
         plans_executed: number,
         files_modified: string[],
         key_decisions: string[],
         verification_status: 'passed' | 'gaps_found'
       },
       compressed_context: CompressedSummary[]
     }
     ```
   - Write to `{phase_dir}/ARCHIVE.json`
   - Return: { archived: true, path: string }

2. **compressContext(phaseDir)** - Compress SUMMARYs to key points only:
   - For each SUMMARY.md:
     - Extract title (first # line)
     - Extract objective (from frontmatter)
     - Extract key_decisions (from frontmatter)
     - Extract tech_stack.added (from frontmatter)
     - Extract key_files.created (from frontmatter)
   - Return array of compressed summaries
   - Target: ~500 tokens per phase instead of full ~5000 tokens

3. **injectRelevantContext(targetPhase, archives)** - Select relevant archives for injection:
   - Get target phase dependencies from ROADMAP.md
   - Filter archives to only dependency phases
   - Extract only: key_decisions, tech_stack, files_created
   - Return compressed context (~100 tokens per dependency)

4. **cleanupEphemeralCheckpoints(phaseNumber)** - Remove phase checkpoints after archive:
   - Use checkpoint cleanup command
   - Remove checkpoints for completed phase
   - Keep only ARCHIVE.json for future reference
   - Return: { cleaned: number }

5. **updateStateWithArchive(phaseNumber, summary)** - Update STATE.md:
   - Remove detailed logs for phase
   - Keep only summary reference
   - Update phase status to 'complete'

Module exports: { archivePhase, compressContext, injectRelevantContext, cleanupEphemeralCheckpoints, updateStateWithArchive }
  </action>
  <verify>
```bash
# Verify module exists and exports
node -e "const a = require('./get-shit-done/bin/phase-archive.js'); console.log(Object.keys(a))"
# Should include: archivePhase, compressContext, injectRelevantContext, cleanupEphemeralCheckpoints, updateStateWithArchive

# Test compressContext on existing phase (should work on Phase 1)
node -e "const a = require('./get-shit-done/bin/phase-archive.js'); a.compressContext('.planning/phases/01-auto-mode-foundation').then(c => console.log('Compressed:', c.length, 'summaries'))"
```
  </verify>
  <done>phase-archive.js exists with archivePhase, compressContext, injectRelevantContext, cleanupEphemeralCheckpoints, updateStateWithArchive functions</done>
</task>

<task type="auto">
  <name>Task 2: Integrate archive commands and wire into workflow</name>
  <files>
    get-shit-done/bin/gsd-tools.js
    get-shit-done/workflows/execute-roadmap.md
  </files>
  <action>
**1. Add phase archive subcommands to gsd-tools.js:**

```javascript
case 'phase': {
  const subcommand = args[1];

  if (subcommand === 'archive') {
    const phaseNumber = parseInt(args[2]);
    const archive = require('./phase-archive.js');
    const result = await archive.archivePhase(phaseNumber);
    console.log(JSON.stringify(result));
  }

  else if (subcommand === 'inject-context') {
    const targetPhase = parseInt(args[2]);
    const archive = require('./phase-archive.js');
    // Load archives for dependency phases
    const context = await archive.injectRelevantContext(targetPhase);
    console.log(JSON.stringify(context));
  }

  else if (subcommand === 'cleanup-checkpoints') {
    const phaseNumber = parseInt(args[2]);
    const archive = require('./phase-archive.js');
    const result = await archive.cleanupEphemeralCheckpoints(phaseNumber);
    console.log(JSON.stringify(result));
  }

  break;
}
```

**2. Update execute-roadmap.md workflow to use archiving:**

Add to execute_phases step after phase completion:
```markdown
4. **Archive phase context** (EXEC-07):
   \`\`\`bash
   # Create archive
   node gsd-tools.js phase archive $PHASE_NUMBER

   # Clean up ephemeral checkpoints
   node gsd-tools.js phase cleanup-checkpoints $PHASE_NUMBER
   \`\`\`

5. **Inject relevant context for next phase:**
   Before spawning next phase coordinator, inject only relevant history:
   \`\`\`bash
   CONTEXT=$(node gsd-tools.js phase inject-context $NEXT_PHASE)
   \`\`\`

   Pass compressed context to sub-coordinator prompt.
```

Ensure workflow references archiving after each phase_complete event.
  </action>
  <verify>
```bash
# Test phase archive command
node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js phase archive 1 2>/dev/null || echo "May fail if Phase 1 not complete - expected"

# Verify execute-roadmap.md has archive steps
grep -c "phase archive\|cleanup-checkpoints\|inject-context" /Users/ollorin/.claude/get-shit-done/workflows/execute-roadmap.md
# Should be 3+
```
  </verify>
  <done>gsd-tools.js responds to "phase archive", "phase inject-context", "phase cleanup-checkpoints" commands. execute-roadmap.md includes archiving steps.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 3: End-to-end integration verification</name>
  <what-built>
Complete Phase 6 autonomous execution infrastructure:
- Roadmap parsing and DAG (Plan 01)
- Execute-roadmap workflow and coordinator (Plan 02)
- Execution logging (Plan 03)
- Checkpoint storage with semantic search (Plan 04)
- Phase archiving and context management (Plan 05, Tasks 1-2)
  </what-built>
  <how-to-verify>
1. **Verify all modules load without errors:**
   ```bash
   node -e "require('./get-shit-done/bin/roadmap-parser.js')"
   node -e "require('./get-shit-done/bin/execution-log.js')"
   node -e "require('./get-shit-done/bin/knowledge-checkpoint.js')"
   node -e "require('./get-shit-done/bin/phase-archive.js')"
   ```
   All should complete without errors.

2. **Verify roadmap parsing works:**
   ```bash
   node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js roadmap parse
   ```
   Should output JSON with 8 phases.

3. **Verify DAG execution order:**
   ```bash
   node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js roadmap dag
   ```
   Phase 6 should appear after 1, 2, 5 in execution_order.

4. **Verify execute-roadmap workflow exists:**
   ```bash
   cat /Users/ollorin/.claude/get-shit-done/workflows/execute-roadmap.md | head -20
   ```

5. **Verify slash command exists:**
   ```bash
   cat /Users/ollorin/.claude/commands/gsd/execute-roadmap.md
   ```

6. **Test checkpoint creation and search:**
   ```bash
   # Create test checkpoint
   node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js checkpoint create \
     --phase 6 --plan-id "06-05" --task "Integration Test" \
     --plan "verify,test,confirm" --completed "verify" --current "test" \
     --key-context "Testing Phase 6 integration" \
     --files "" --decisions "" --next-steps "Run full test"

   # Search for it
   node /Users/ollorin/.claude/get-shit-done/bin/gsd-tools.js checkpoint search --phase 6
   ```

If all verifications pass, type "approved".
If any fail, describe the failures.
  </how-to-verify>
  <resume-signal>Type "approved" or describe issues found</resume-signal>
</task>

</tasks>

<verification>
- phase-archive.js exists in get-shit-done/bin/
- All functions exported: archivePhase, compressContext, injectRelevantContext, cleanupEphemeralCheckpoints, updateStateWithArchive
- gsd-tools.js responds to "phase archive/inject-context/cleanup-checkpoints" commands
- execute-roadmap.md includes archiving after phase completion
- All Plan 01-04 infrastructure integrated and working
- End-to-end flow verified by human
</verification>

<success_criteria>
- Phase archiving creates ARCHIVE.json with compressed context
- Context injection provides only relevant history
- Checkpoint cleanup removes ephemeral checkpoints
- Full Phase 6 infrastructure integrated and testable
- Human verification confirms all components work together
</success_criteria>

<output>
After completion, create `.planning/phases/06-autonomous-execution-core/06-05-SUMMARY.md`
</output>
