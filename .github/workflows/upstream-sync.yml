# Upstream Sync Workflow
# Detects changes in upstream gsd-build/get-shit-done, merges them,
# regenerates the Copilot wrapper layer, verifies it, and creates/updates a PR.
#
# One-time prerequisite: create GitHub labels before first run:
#   gh label create upstream-sync --color 0075ca --description "Upstream sync PR"
#   gh label create automated --color e4e669 --description "Automated workflow"
#
# To enable daily schedule, uncomment the schedule block below.

# on:
#   schedule:
#     - cron: '0 6 * * *'  # Daily at 06:00 UTC

on:
  workflow_dispatch:

name: Upstream Sync

concurrency:
  group: upstream-sync
  cancel-in-progress: false

env:
  UPSTREAM_REPO: gsd-build/get-shit-done
  UPSTREAM_BRANCH: main
  DEFAULT_BRANCH: main

jobs:
  sync:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    permissions:
      contents: write
      pull-requests: write
      issues: write

    env:
      GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - name: Checkout fork (full history)
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Configure git identity
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Add upstream remote and fetch
        run: |
          git remote add upstream "https://github.com/${{ env.UPSTREAM_REPO }}.git" || true
          git fetch upstream "${{ env.UPSTREAM_BRANCH }}"

      - name: Detect upstream changes
        id: detect
        run: |
          FORK_HEAD=$(git rev-parse HEAD)
          UPSTREAM_HEAD=$(git rev-parse "upstream/${{ env.UPSTREAM_BRANCH }}")
          SHORT_SHA=$(git rev-parse --short "upstream/${{ env.UPSTREAM_BRANCH }}")

          echo "fork_head=$FORK_HEAD" >> "$GITHUB_OUTPUT"
          echo "upstream_head=$UPSTREAM_HEAD" >> "$GITHUB_OUTPUT"
          echo "short_sha=$SHORT_SHA" >> "$GITHUB_OUTPUT"

          # Check if upstream has commits not in fork HEAD
          DIFF_COUNT=$(git rev-list HEAD..upstream/${{ env.UPSTREAM_BRANCH }} --count)
          if [ "$DIFF_COUNT" -eq 0 ]; then
            echo "no_changes=true" >> "$GITHUB_OUTPUT"
            echo "No upstream changes detected. Exiting."
          else
            echo "no_changes=false" >> "$GITHUB_OUTPUT"
            echo "Detected $DIFF_COUNT new upstream commit(s)."
          fi

      - name: Exit silently if no changes
        if: steps.detect.outputs.no_changes == 'true'
        run: exit 0

      - name: Create/reset working branch
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          git checkout -B automated/upstream-sync origin/${{ env.DEFAULT_BRANCH }}

      - name: Merge upstream changes
        if: steps.detect.outputs.no_changes != 'true'
        id: merge
        run: |
          if ! git merge "upstream/${{ env.UPSTREAM_BRANCH }}" --no-edit; then
            CONFLICT_FILES=$(git diff --name-only --diff-filter=U | tr '\n' '\n- ' | sed 's/^/- /')
            cat > /tmp/issue-body.md << 'ISSUE_EOF'
          ## Upstream Sync Merge Conflict

          The automated upstream sync encountered a merge conflict and could not complete.

          **Upstream commit:** ${{ steps.detect.outputs.short_sha }}
          **Upstream HEAD:** ${{ steps.detect.outputs.upstream_head }}
          **Fork HEAD (before merge):** ${{ steps.detect.outputs.fork_head }}

          ### Conflicting files
          ISSUE_EOF
            git diff --name-only --diff-filter=U | sed 's/^/- /' >> /tmp/issue-body.md
            cat >> /tmp/issue-body.md << 'ISSUE_EOF'

          ### Resolution steps
          1. Check out the `automated/upstream-sync` branch locally
          2. Resolve conflicts manually
          3. Run `node scripts/generate-prompts.mjs && node scripts/verify-prompts.mjs`
          4. Push and open PR manually

          **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ISSUE_EOF
            gh issue create \
              --title "Upstream sync merge conflict (upstream@${{ steps.detect.outputs.short_sha }})" \
              --body-file /tmp/issue-body.md \
              --label "upstream-sync"
            exit 1
          fi

      - name: Run prompt generator
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          node scripts/generate-prompts.mjs > /tmp/gen_output.txt 2>&1
          echo "Generator output:"
          cat /tmp/gen_output.txt

      - name: Run prompt verifier
        if: steps.detect.outputs.no_changes != 'true'
        id: verify
        run: |
          if ! node scripts/verify-prompts.mjs > /tmp/ver_output.txt 2>&1; then
            cat > /tmp/issue-body.md << 'ISSUE_EOF'
          ## Upstream Sync Verifier Failure

          The upstream sync completed merge and regeneration, but the verifier failed. No PR was created.

          **Upstream commit:** ${{ steps.detect.outputs.short_sha }}
          **Upstream HEAD:** ${{ steps.detect.outputs.upstream_head }}

          ### Generator output
          ```
          ISSUE_EOF
            cat /tmp/gen_output.txt >> /tmp/issue-body.md
            cat >> /tmp/issue-body.md << 'ISSUE_EOF'
          ```

          ### Verifier output
          ```
          ISSUE_EOF
            cat /tmp/ver_output.txt >> /tmp/issue-body.md
            cat >> /tmp/issue-body.md << 'ISSUE_EOF'
          ```

          ### Resolution steps
          1. Review the verifier errors above
          2. Fix `scripts/generate-prompts.mjs` or `scripts/verify-prompts.mjs` as needed (do NOT edit upstream content)
          3. Re-run workflow or fix and push manually

          **Workflow run:** ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
          ISSUE_EOF
            gh issue create \
              --title "Upstream sync verifier failed (upstream@${{ steps.detect.outputs.short_sha }})" \
              --body-file /tmp/issue-body.md \
              --label "upstream-sync"
            exit 1
          fi
          echo "Verifier passed."
          cat /tmp/ver_output.txt

      - name: Commit regenerated wrapper files
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          git add .github/prompts/ .github/agents/ .github/instructions/ || true
          if ! git diff --cached --quiet; then
            git commit -m "chore: regenerate Copilot wrapper layer for upstream@${{ steps.detect.outputs.short_sha }}"
          else
            echo "No wrapper file changes to commit."
          fi

      - name: Force-push working branch
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          git push --force-with-lease origin automated/upstream-sync

      - name: Build PR body
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          RANGE="${{ steps.detect.outputs.fork_head }}...${{ steps.detect.outputs.upstream_head }}"
          CHANGED_FILES=$(git diff --name-only "${{ steps.detect.outputs.fork_head }}" "${{ steps.detect.outputs.upstream_head }}" -- commands/gsd/ get-shit-done/ agents/ 2>/dev/null | sed 's/^/- /' || echo "- (none detected)")

          cat > /tmp/pr-body.md << PR_EOF
          ## Upstream sync from \`gsd-build/get-shit-done\`

          **Upstream commit:** \`${{ steps.detect.outputs.short_sha }}\`
          **Commit range:** \`${RANGE}\`

          ### Changed upstream files
          ${CHANGED_FILES}

          ### Copilot wrapper layer
          âœ… Generator and verifier passed. Wrapper files regenerated automatically.

          ---
          *This PR was created automatically by the upstream-sync workflow.*
          *See [workflow run](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}) for details.*
          PR_EOF

      - name: Create or update PR
        if: steps.detect.outputs.no_changes != 'true'
        run: |
          SHORT_SHA="${{ steps.detect.outputs.short_sha }}"
          PR_TITLE="sync: upstream changes from ${SHORT_SHA}"

          EXISTING_PR=$(gh pr list \
            --head "automated/upstream-sync" \
            --state open \
            --json number \
            --jq '.[0].number' 2>/dev/null || echo "")

          if [ -z "$EXISTING_PR" ]; then
            gh pr create \
              --base "${{ env.DEFAULT_BRANCH }}" \
              --head "automated/upstream-sync" \
              --title "${PR_TITLE}" \
              --body-file /tmp/pr-body.md \
              --label "upstream-sync" \
              --label "automated"
            echo "Created new PR."
          else
            gh pr edit "$EXISTING_PR" \
              --title "${PR_TITLE}" \
              --body-file /tmp/pr-body.md
            echo "Updated existing PR #${EXISTING_PR}."
          fi

